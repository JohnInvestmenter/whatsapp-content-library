<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Content Library</title>
  <link rel="icon" href="data:,"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --ink:#0b0b0c; --fg:#0b0b0c; --muted:#f4f5f7; --muted-ink:#6b7280;
      --brand:#d6b160; --brand-ink:#000; --chip:#0f766e; --chip-ink:#ecfeff;
      --card:#ffffff; --border:rgba(0,0,0,.07);
    }
    body{ background:#fff; color:var(--fg); }
    .card{ background:var(--card); border:1px solid var(--border); }
    .chip{ border-radius:9999px; padding:2px 8px; font-size:12px }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--border); padding:.5rem .75rem; border-radius:.75rem; }
    .btn:hover:not([disabled]){ background:rgba(0,0,0,.03) }
    .btn-brand{ background:var(--brand); color:var(--brand-ink); border-color:transparent; }
    .btn-brand:hover:not([disabled]){ filter:brightness(.95) }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .shadow-soft{ box-shadow:0 8px 30px rgba(0,0,0,.06) }
    .scrollbar-thin{ scrollbar-width: thin; }
    .scrollbar-thin::-webkit-scrollbar{ height:6px; width:6px;}
    .scrollbar-thin::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.2); border-radius:999px;}
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <header class="flex justify-between items-center">
      <h1 class="text-3xl font-bold flex items-center gap-2 tracking-tight">
        <i data-lucide="message-circle"></i> WhatsApp Content Library
      </h1>
      <div class="flex gap-2">
        <button id="syncBtn" class="btn"><i data-lucide="refresh-cw"></i> Sync Now</button>
        <button id="addBtn" class="btn btn-brand"><i data-lucide="plus"></i> Add Content</button>
      </div>
    </header>

    <!-- Search / Filter -->
    <section class="flex gap-2">
      <input id="searchInput" placeholder="Search..." class="flex-1 p-3 rounded-lg border border-[var(--border)] bg-white"/>
      <select id="categorySelect" class="p-3 rounded-lg border border-[var(--border)] bg-white">
        <option value="all">All Categories</option>
      </select>
    </section>

    <!-- Grid -->
    <section>
      <div id="contentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- Stats -->
    <section class="card rounded-xl p-4 shadow-soft">
      <h2 class="font-semibold mb-2">Content Statistics</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div><div id="statTotal" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Total Content</div></div>
        <div><div id="statUses" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Total Uses</div></div>
        <div><div id="statCategories" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Categories</div></div>
        <div><div id="statRecent" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Recently Used</div></div>
      </div>
    </section>
  </div>

  <!-- Add Content Modal -->
  <div id="addModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
    <div class="card w-full max-w-2xl rounded-xl shadow-soft flex flex-col max-h-[90vh]">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
        <h2 class="text-xl font-semibold">Add New Content</h2>
        <button id="closeModal" class="btn"><i data-lucide="x"></i></button>
      </div>

      <!-- Modal body (scrollable) -->
      <div class="p-4 space-y-4 overflow-y-auto scrollbar-thin" style="max-height:60vh">
        <div>
          <label class="block text-sm mb-1">Title</label>
          <input id="titleInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-white" placeholder="Content title..."/>
        </div>

        <div>
          <label class="block text-sm mb-1">Category</label>
          <select id="categoryInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-white"></select>
        </div>

        <div>
          <label class="block text-sm mb-1">Content</label>
          <textarea id="contentInput" rows="8" class="w-full p-2 rounded-lg border border-[var(--border)] bg-white" placeholder="Write your message... Use **bold**, __italic__, ~~strikethrough~~, and `code`."></textarea>
        </div>

        <div>
          <label class="block text-sm mb-1">Tags (comma separated)</label>
          <input id="tagsInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-white" placeholder="motivation, weekly, inspiration"/>
        </div>

        <div>
          <label class="block text-sm mb-2">Attachments (image / video / pdf / doc)</label>
          <div class="flex items-center gap-2">
            <input id="fileInput" type="file" multiple class="hidden"/>
            <button id="pickFiles" class="btn"><i data-lucide="paperclip"></i> <span id="pickFilesText">Choose files</span></button>
            <span class="text-sm text-[var(--muted-ink)]">Uploaded to Drive; links saved with the content.</span>
          </div>
          <div id="attachmentsList" class="mt-2 flex flex-wrap gap-2"></div>
        </div>

        <div>
          <label class="block text-sm mb-1">WhatsApp Preview</label>
          <div id="waPreview" class="rounded-lg border border-[var(--border)] bg-[var(--muted)] p-3 text-sm max-h-48 overflow-auto whitespace-pre-wrap scrollbar-thin">(start typing above)</div>
        </div>
      </div>

      <!-- Modal footer (fixed) -->
      <div class="p-4 border-t border-[var(--border)] flex justify-end gap-2">
        <button id="clearAdd" class="btn"><i data-lucide="eraser"></i> Clear</button>
        <button id="cancelAdd" class="btn">Cancel</button>
        <button id="saveAdd" class="btn btn-brand" disabled>
          <span id="saveText">Save</span>
          <svg id="saveSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API = 'https://whatsapp-content-library.vercel.app/api/contents';
  const DRIVE_UPLOAD_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwWgZ3B3vcN4flFQo1-Ul-AVjVGZozfoe8RDcbr8ez2d_d7r9XvQ7tnePY5q8ZC4w7Ziw/exec';
  const categories = ['Motivation','Tech Tips','Fun Facts','Announcements','Events','Educational'];

  // ====== STATE ======
  lucide.createIcons();
  let contents = [];
  let newAttachments = []; // {name, url, mimeType}
  let isUploading = false; // <— guard uploads

  // ====== UTILS ======
  const escapeHtml = (s='') => s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  const formatForWhatsApp = (text='') => text
    .replace(/\*\*(.*?)\*\*/g,'*$1*')
    .replace(/__(.*?)__/g,'_$1_')
    .replace(/~~(.*?)~~/g,'~$1~')
    .replace(/`(.*?)`/g,'$1');

  // Base64 (keeps original filename)
  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = ()=>{
        const res = fr.result; // data:...;base64,XXX
        const base64 = String(res).split(',')[1] || '';
        resolve({ name: file.name, mimeType: file.type || 'application/octet-stream', dataBase64: base64 });
      };
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  // Upload to GAS; IMPORTANT: no explicit Content-Type (avoid preflight)
  async function uploadFilesToDrive(files){
    const encoded = await Promise.all(files.map(fileToBase64));
    const res = await fetch(DRIVE_UPLOAD_ENDPOINT, { method:'POST', body: JSON.stringify({ files: encoded }) });
    const data = await res.json().catch(()=>({success:false,error:'Invalid JSON from server'}));
    if (!res.ok || !data.success) throw new Error(data.error || ('HTTP '+res.status));
    return (data.files||[]).map(f=>({ name: f.name, url: f.webViewLink || f.url, mimeType: f.mimeType }));
  }

  function setUploading(on){
    isUploading = on;
    // Disable/enable Save & Pick Files, update texts
    saveAdd.disabled = on;
    pickFiles.disabled = on;
    document.getElementById('saveText').textContent = on ? 'Uploading…' : 'Save';
    document.getElementById('saveSpinner').classList.toggle('hidden', !on);
    document.getElementById('pickFilesText').textContent = on ? 'Uploading…' : 'Choose files';
  }

  function canSaveNow(){
    const hasTitle = (titleInput.value||'').trim().length > 0;
    const hasContent = (contentInput.value||'').trim().length > 0;
    return hasTitle && hasContent && !isUploading;
  }

  function updateSaveEnabled(){
    saveAdd.disabled = !canSaveNow();
  }

  // ====== API ======
  async function syncContents(){
    try{
      const res = await fetch(API);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      contents = Array.isArray(data.items)? data.items : [];
      renderCategories();
      render();
    }catch(e){ console.error(e); alert('Sync failed: '+e.message); }
  }

  async function createItem(){
    if (isUploading) return; // guard
    const title = (titleInput.value||'').trim();
    const category = categoryInput.value || 'General';
    const content = (contentInput.value||'').trim();
    const tags = (tagsInput.value||'').split(',').map(t=>t.trim()).filter(Boolean);

    if(!title || !content){ updateSaveEnabled(); return; }

    const body = {
      title,
      content,
      formattedContent: formatForWhatsApp(content),
      category,
      tags,
      dateCreated: new Date().toISOString().slice(0,10),
      useCount: 0,
      attachments: newAttachments.map(a=>({ name:a.name, url:a.url })) // Notion will store as files[]
    };

    try{
      saveAdd.disabled = true; // prevent double click during POST
      const r = await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok || j.error){ throw new Error(j.message || j.error || ('HTTP '+r.status)); }
      closeModalFn();
      clearModalFields();
      await syncContents();
      alert('Content added!');
    }catch(err){ console.error(err); alert('Failed to add content: '+err.message); }
    finally{ updateSaveEnabled(); }
  }

  // ====== RENDER ======
  function render(){
    const grid = document.getElementById('contentGrid');
    const search = (document.getElementById('searchInput').value||'').toLowerCase();
    const cat = document.getElementById('categorySelect').value;

    const filtered = contents.filter(c =>
      (!search || (c.title||'').toLowerCase().includes(search) || (c.content||'').toLowerCase().includes(search) || (c.tags||[]).some(t=> (t||'').toLowerCase().includes(search))) &&
      (cat==='all' || c.category===cat)
    );

    grid.innerHTML = filtered.map(c => `
      <div class="card p-4 rounded-xl shadow-soft space-y-3">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-semibold text-lg">${escapeHtml(c.title||'')}</h3>
            <div class="flex items-center gap-2 mt-1">
              <span class="chip bg-[var(--brand)] text-[var(--brand-ink)]">${escapeHtml(c.category||'')}</span>
              <span class="text-xs text-[var(--muted-ink)]">Used ${Number(c.useCount||0)} times</span>
            </div>
          </div>
          <button class="btn copyBtn" data-id="${escapeHtml(c.id||'')}"><i data-lucide="copy"></i> Copy</button>
        </div>

        ${(c.attachments&&c.attachments.length) ? `
        <div class="flex flex-wrap gap-2">
          ${c.attachments.map(a => `
            <a href="${escapeHtml(a.url)}" target="_blank" class="chip bg-[var(--chip)] text-[var(--chip-ink)] hover:opacity-90">${escapeHtml(a.name)}</a>
          `).join('')}
        </div>` : ''}

        <div class="rounded-lg border border-[var(--border)] bg-[var(--muted)] p-3 text-sm">
          <pre class="whitespace-pre-wrap">${escapeHtml(c.formattedContent||c.content||'')}</pre>
        </div>

        <div class="flex flex-wrap gap-1">
          ${(c.tags||[]).map(t=>`<span class="chip bg-black/5">${escapeHtml('#'+t)}</span>`).join('')}
        </div>

        <div class="text-xs text-[var(--muted-ink)] flex justify-between">
          <span>Created: ${escapeHtml(c.dateCreated||'')}</span>
          ${c.lastUsed ? `<span>Last used: ${escapeHtml(c.lastUsed)}</span>` : '<span></span>'}
        </div>
      </div>
    `).join('');

    document.querySelectorAll('.copyBtn').forEach(btn=>{
      btn.addEventListener('click', ()=> copyToClipboard(btn.getAttribute('data-id')));
    });

    document.getElementById('statTotal').textContent = contents.length;
    document.getElementById('statUses').textContent = contents.reduce((a,c)=>a+(c.useCount||0),0);
    document.getElementById('statCategories').textContent = new Set(contents.map(c=>c.category)).size;
    document.getElementById('statRecent').textContent = contents.filter(c=>c.lastUsed).length;

    lucide.createIcons();
  }

  function renderCategories(){
    const sel = document.getElementById('categorySelect');
    const current = sel.value || 'all';
    sel.innerHTML = '<option value="all">All Categories</option>' + categories.map(c=>`<option value="${c}">${c}</option>`).join('');
    sel.value = current;

    const modalSel = document.getElementById('categoryInput');
    modalSel.innerHTML = categories.map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  async function copyToClipboard(id){
    try{
      const item = contents.find(x=>String(x.id)===String(id));
      if(!item) return alert('Item not found.');
      await navigator.clipboard.writeText(item.formattedContent || item.content || '');
      item.useCount = Number(item.useCount||0) + 1;
      item.lastUsed = new Date().toISOString().slice(0,10);
      render();
      alert('Copied to clipboard!');
    }catch(e){ console.error(e); alert('Copy failed.'); }
  }

  // ====== MODAL / UI ======
  const addBtn = document.getElementById('addBtn');
  const syncBtn = document.getElementById('syncBtn');
  const addModal = document.getElementById('addModal');
  const closeModal = document.getElementById('closeModal');
  const cancelAdd = document.getElementById('cancelAdd');
  const clearAdd = document.getElementById('clearAdd');
  const saveAdd = document.getElementById('saveAdd');

  const titleInput = document.getElementById('titleInput');
  const categoryInput = document.getElementById('categoryInput');
  const contentInput = document.getElementById('contentInput');
  const tagsInput = document.getElementById('tagsInput');
  const waPreview = document.getElementById('waPreview');
  const fileInput = document.getElementById('fileInput');
  const pickFiles = document.getElementById('pickFiles');
  const attachmentsList = document.getElementById('attachmentsList');

  function openModal(){
    addModal.classList.remove('hidden'); addModal.classList.add('flex'); titleInput.focus();
    updateSaveEnabled();
  }
  function closeModalFn(){ addModal.classList.add('hidden'); addModal.classList.remove('flex'); }
  function clearModalFields(){
    titleInput.value='';
    categoryInput.value=categories[0];
    contentInput.value='';
    tagsInput.value='';
    waPreview.textContent='(start typing above)';
    newAttachments = [];
    drawAttachmentsUI();
    updateSaveEnabled();
  }

  addBtn.addEventListener('click', openModal);
  closeModal.addEventListener('click', closeModalFn);
  cancelAdd.addEventListener('click', closeModalFn);
  clearAdd.addEventListener('click', clearModalFields);
  saveAdd.addEventListener('click', createItem);

  contentInput.addEventListener('input', ()=>{ waPreview.textContent = formatForWhatsApp(contentInput.value||''); updateSaveEnabled(); });
  titleInput.addEventListener('input', updateSaveEnabled);
  document.getElementById('searchInput').addEventListener('input', render);
  document.getElementById('categorySelect').addEventListener('change', render);
  syncBtn.addEventListener('click', syncContents);

  // Attachments UI
  function drawAttachmentsUI(){
    attachmentsList.innerHTML = newAttachments.map((a,idx)=>`
      <div class="flex items-center gap-2 border border-[var(--border)] rounded-lg px-2 py-1">
        <i data-lucide="file" class="w-4 h-4"></i>
        <a href="${escapeHtml(a.url)}" target="_blank" class="text-sm underline">${escapeHtml(a.name)}</a>
        <button class="removeAtt btn text-xs" data-idx="${idx}" ${isUploading?'disabled':''}><i data-lucide="x"></i></button>
      </div>
    `).join('') || '<div class="text-sm text-[var(--muted-ink)]">No files yet.</div>';
    attachmentsList.querySelectorAll('.removeAtt').forEach(b=>{
      b.addEventListener('click', ()=>{
        const i = Number(b.getAttribute('data-idx'));
        newAttachments.splice(i,1);
        drawAttachmentsUI();
      });
    });
    lucide.createIcons();
  }

  // File picking & upload — Save is disabled until uploads complete
  pickFiles.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files||[]);
    if(!files.length) return;
    try{
      setUploading(true);
      const uploaded = await uploadFilesToDrive(files); // original names
      newAttachments.push(...uploaded);
      drawAttachmentsUI();
      alert('Uploaded to Drive.');
    }catch(err){
      console.error(err);
      alert('Drive upload failed: '+err.message);
    }finally{
      fileInput.value='';
      setUploading(false);
      updateSaveEnabled();
    }
  });

  // ====== BOOT ======
  window.addEventListener('DOMContentLoaded', ()=>{
    renderCategories();
    syncContents();
  });
</script>
</body>
</html>
