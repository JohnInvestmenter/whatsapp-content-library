<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>InvestMenter – WhatsApp Content Library</title>
  <link rel="icon" href="https://onecdn.io/media/ffb500c6-8305-4802-8cf9-6b55e6bd5ed5/md2x" />
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#F4C753',
            'background-light': '#f8f7f6',
            'background-dark': '#221d10',
            'content-light': '#111811',
            'content-dark': '#e8f0e8',
            'subtle-light': '#608a60',
            'subtle-dark': '#a0c2a0',
            'border-light': '#dbe6db',
            'border-dark': '#304a30'
          },
          fontFamily: { display: 'Lexend' },
          borderRadius: { DEFAULT: '0.25rem', lg: '0.5rem', xl: '0.75rem', full: '9999px' }
        }
      }
    };
  </script>
  <style>
    .form-select{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23608a60' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right .5rem center;background-repeat:no-repeat;background-size:1.5em 1.5em;padding-right:2.5rem;-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .dark .form-select{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a0c2a0' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e")}
    .scrollbar-thin{scrollbar-width:thin}
    .scrollbar-thin::-webkit-scrollbar{height:6px;width:6px}
    .scrollbar-thin::-webkit-scrollbar-thumb{background:rgba(0,0,0,.25);border-radius:9999px}
    .modal-hidden { display: none; }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-content-light dark:text-content-dark">
<div class="flex flex-col min-h-screen">
  <header class="sticky top-0 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm z-10 border-b border-border-light dark:border-border-dark">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <img src="https://onecdn.io/media/ffb500c6-8305-4802-8cf9-6b55e6bd5ed5/md2x" alt="InvestMenter" class="h-8 w-auto object-contain" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='https://api.dicebear.com/7.x/initials/svg?seed=IM';"/>
          <h1 class="text-xl font-bold">InvestMenter WhatsApp Content Library</h1>
        </div>
        <div id="auth-container" class="flex items-center gap-4">
          </div>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-8">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
          <div>
            <h2 class="text-2xl font-semibold tracking-tight">Content Library</h2>
            <p class="text-subtle-light dark:text-subtle-dark mt-1">Manage your content for WhatsApp</p>
          </div>
          <div class="flex items-center gap-3">
            <button id="syncBtn" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-primary/20 hover:bg-primary/30 dark:bg-primary/30 dark:hover:bg-primary/40 transition-colors text-sm font-bold">
              <span class="material-symbols-outlined text-base">sync</span> Reload Data
            </button>
            <button id="manageCategoriesBtn" class="hidden flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-primary/20 hover:bg-primary/30 dark:bg-primary/30 dark:hover:bg-primary/40 transition-colors text-sm font-bold">
              <span class="material-symbols-outlined text-base">category</span> Manage Categories
            </button>
            <button id="addContentBtn" class="hidden flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-primary text-white hover:opacity-90 transition-opacity text-sm font-bold">
              <span class="material-symbols-outlined text-base">add</span> Add Content
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="searchInput" placeholder="Search…" class="px-3 py-2 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark"/>
          <select id="categoryFilterSelect" class="form-select px-3 py-2 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark"><option value="all">All Categories</option></select>
          <div class="flex items-stretch">
            <button id="clearFilters" class="px-3 py-2 rounded-l-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark hover:bg-primary/10 dark:hover:bg-primary/20 text-sm font-bold">Clear</button>
            <button id="copySelected" class="px-3 py-2 rounded-r-lg border-y border-r border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark hover:bg-primary/10 dark:hover:bg-primary/20 text-sm font-bold" title="Copy highlighted (first) item">Quick Copy</button>
          </div>
        </div>

        <div id="contentGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 items-stretch"></div>
        <div id="messageBar" class="hidden mt-4"></div>
      </div>

      <div id="content-form-container" class="lg:col-span-1 space-y-8 hidden">
        <div class="bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark p-6 rounded-lg space-y-6">
          <h3 id="formTitle" class="text-xl font-bold">Add New Content</h3>
          <form id="addForm" class="space-y-4">
            <input type="hidden" id="editItemId" />
            <div>
              <label for="title" class="text-sm font-medium">Title</label>
              <input id="title" class="mt-1 block w-full px-3 py-2 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg focus:outline-none focus:ring-primary focus:border-primary sm:text-sm placeholder-subtle-light dark:placeholder-subtle-dark" placeholder="Enter title" type="text" required/>
            </div>
            <div>
              <label for="category" class="text-sm font-medium">Category</label>
              <select id="category" class="form-select mt-1 block w-full pl-3 pr-10 py-2 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg focus:outline-none focus:ring-primary focus:border-primary sm:text-sm appearance-none" required></select>
            </div>
            <div>
              <label for="content" class="text-sm font-medium">Content</label>
              <textarea id="content" class="mt-2 block w-full px-3 py-2 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg focus:outline-none focus:ring-primary focus:border-primary sm:text-sm placeholder-subtle-light dark:placeholder-subtle-dark" placeholder="Use **bold**, __italic__, ~~strike~~ and `code`." rows="6" required></textarea>
            </div>
            <div>
              <label for="tags" class="text-sm font-medium">Tags</label>
              <input id="tags" class="mt-1 block w-full px-3 py-2 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg focus:outline-none focus:ring-primary focus:border-primary sm:text-sm placeholder-subtle-light dark:placeholder-subtle-dark" placeholder="Enter tags, separated by commas" type="text"/>
            </div>
            <div class="pt-4 flex flex-col sm:flex-row-reverse gap-3">
              <button id="saveBtn" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-white bg-primary hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-offset-background-dark disabled:opacity-50" type="submit">
                <span id="saveText">Save</span>
                <svg id="saveSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a 8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z"></path></svg>
              </button>
              <button id="cancelBtn" class="w-full sm:w-auto inline-flex justify-center py-2 px-4 border border-border-light dark:border-border-dark rounded-lg shadow-sm text-sm font-bold bg-background-light dark:bg-background-dark hover:bg-primary/10 dark:hover:bg-primary/20" type="button">Cancel</button>
            </div>
          </form>
        </div>
        <div class="bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark p-6 rounded-lg space-y-4">
          <h3 class="text-xl font-bold">WhatsApp Preview</h3>
          <div class="bg-gray-200 dark:bg-gray-800 p-4 rounded-lg">
            <div class="flex items-start gap-2.5">
              <span class="relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full">
                <img alt="User Avatar" class="aspect-square h-full w-full" referrerpolicy="no-referrer" src="https://api.dicebear.com/7.x/initials/svg?seed=IM" />
              </span>
              <div class="grid gap-1 w-full">
                <div id="previewTitle" class="font-semibold text-gray-900 dark:text-gray-50">—</div>
                <div id="waPreview" class="text-sm leading-snug text-gray-700 dark:text-gray-300 whitespace-pre-wrap max-h-48 overflow-auto scrollbar-thin">(start typing…)</div>
              </div>
            </div>
          </div>
        </div>
      </div> </div>
  </main>
</div>

<div id="loginModal" class="modal-hidden fixed inset-0 flex items-center justify-center bg-black/60 z-50 p-4">
    <div class="w-full max-w-sm bg-background-light dark:bg-background-dark rounded-lg shadow-xl p-6">
        <h3 class="text-lg font-bold mb-4">Login</h3>
        <form id="loginForm">
            <div class="space-y-4">
                <input id="username" type="text" placeholder="Username (admin or editor)" class="block w-full px-3 py-2 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg" required>
                <input id="password" type="password" placeholder="Password (password)" class="block w-full px-3 py-2 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg" required>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="loginCancel" class="px-4 py-2 rounded-lg border border-border-light dark:border-border-dark text-sm font-bold">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white text-sm font-bold">Login</button>
            </div>
        </form>
    </div>
</div>

<div id="categoryModal" class="modal-hidden fixed inset-0 flex items-center justify-center bg-black/60 z-50 p-4">
    <div class="w-full max-w-md bg-background-light dark:bg-background-dark rounded-lg shadow-xl">
        <div class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark">
            <h3 class="text-lg font-bold">Manage Categories</h3>
            <button id="categoryClose" class="p-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div id="categoryList" class="p-6 max-h-96 overflow-y-auto space-y-3"></div>
        <div class="p-4 border-t border-border-light dark:border-border-dark">
            <form id="addCategoryForm" class="flex gap-2">
                <input id="newCategoryName" type="text" class="flex-grow px-3 py-2 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg" placeholder="New category name" required>
                <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white text-sm font-bold">Add</button>
            </form>
        </div>
    </div>
</div>

<div id="historyModal" class="modal-hidden fixed inset-0 flex items-center justify-center bg-black/60 z-50 p-4">
    <div class="w-full max-w-2xl bg-background-light dark:bg-background-dark rounded-lg shadow-xl">
        <div class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark">
            <h3 class="text-lg font-bold">Revision History</h3>
            <button id="historyClose" class="p-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div id="historyList" class="p-6 max-h-[60vh] overflow-y-auto space-y-4"></div>
    </div>
</div>


<script>
// =================================================================================
// ===== CONFIG & STATE ============================================================
// =================================================================================
let contents = [];
let categories = ['Motivation', 'Tech Tips', 'Fun Facts', 'Announcements'];
let currentUser = null; // { username, role }
let isEditing = null; // Stores ID of item being edited

// =================================================================================
// ===== MOCK AUTHENTICATION (FOR DEMO) ============================================
// =================================================================================
const mockUsers = [
    { username: 'admin', password: 'password', role: 'admin' },
    { username: 'editor', password: 'password', role: 'editor' },
];

function login(username, password) {
    const user = mockUsers.find(u => u.username === username && u.password === password);
    if (user) {
        currentUser = { username: user.username, role: user.role };
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
        return true;
    }
    return false;
}

function logout() {
    currentUser = null;
    sessionStorage.removeItem('currentUser');
    updateUIVisibility();
}

function hasPermission(requiredRole) {
    if (!currentUser) return false;
    if (currentUser.role === 'admin') return true;
    return currentUser.role === requiredRole;
}

function checkSession() {
    const user = sessionStorage.getItem('currentUser');
    if (user) {
        currentUser = JSON.parse(user);
    }
}

// =================================================================================
// ===== UTILS =====================================================================
// =================================================================================
const $ = (sel) => document.querySelector(sel);
const messageBar = $('#messageBar');

const escapeHtml = (s = '') => s.toString().replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));

const toWhatsApp = (text = '') => text.replace(/\*\*(.*?)\*\*/g, '*$1*').replace(/__(.*?)__/g, '_$1_').replace(/~~(.*?)~~/g, '~$1~');
const toHTML = (text = '') => escapeHtml(text).replace(/\*(.*?)\*/g, '<strong>$1</strong>').replace(/_(.*?)_/g, '<em>$1</em>').replace(/~(.*?)~/g, '<s>$1</s>');

function toast(type, text, duration = 3000) {
    messageBar.className = `p-3 rounded-lg border text-sm ${type === 'error' ? 'border-red-400 text-red-200 bg-red-900/20' : 'border-emerald-400 text-emerald-200 bg-emerald-900/20'}`;
    messageBar.textContent = text;
    setTimeout(() => { messageBar.className = 'hidden'; }, duration);
}

// =================================================================================
// ===== API & DATA HANDLING =======================================================
// =================================================================================

// THIS IS THE NEW, UPDATED FUNCTION. IT LOADS DATA LOCALLY.
async function syncContents() {
    // We now load data directly, bypassing any external network calls.
    const sampleData = {
        "items": [
            { "id": 1, "title": "Welcome to the Library!", "content": "This is your first piece of content. Use the __edit__, **delete**, or view its history.", "formattedContent": "This is your first piece of content. Use the _edit_, *delete*, or view its history.", "category": "Announcements", "tags": ["welcome", "getting-started"], "dateCreated": "2025-10-02T10:00:00.000Z", "lastModified": "2025-10-02T10:00:00.000Z", "useCount": 1, "revisions": [] },
            { "id": 2, "title": "Motivational Quote", "content": "The only way to do great work is to love what you do. --Steve Jobs", "formattedContent": "The only way to do great work is to love what you do. --Steve Jobs", "category": "Motivation", "tags": ["inspiration", "quotes"], "dateCreated": "2025-10-01T11:00:00.000Z", "lastModified": "2025-10-01T11:00:00.000Z", "useCount": 5, "revisions": [] },
            { "id": 3, "title": "Tech Tip of the Day", "content": "You can use `Ctrl`+`Shift`+`V` to paste text without formatting.", "formattedContent": "You can use `Ctrl`+`Shift`+`V` to paste text without formatting.", "category": "Tech Tips", "tags": ["productivity", "windows", "mac"], "dateCreated": "2025-09-30T12:00:00.000Z", "lastModified": "2025-09-30T12:00:00.000Z", "useCount": 12, "revisions": [] }
        ]
    };
    
    toast('ok', 'Loading local data...');
    $('#syncBtn').classList.add('opacity-50', 'pointer-events-none');
    
    try {
        contents = sampleData.items || [];
        const uniqueCategories = [...new Set(contents.map(c => c.category).concat(categories))].filter(Boolean);
        categories = uniqueCategories.sort();
        
        renderAll();
        toast('ok', 'Content loaded successfully!');
    } catch (e) {
        console.error("Load failed:", e);
        toast('error', `Failed to load local content: ${e.message}`);
        $('#contentGrid').innerHTML = `<div class="col-span-full border border-dashed rounded-lg p-8 text-center text-subtle-light dark:text-subtle-dark">Could not load local content.</div>`;
    } finally {
        $('#syncBtn').classList.remove('opacity-50', 'pointer-events-none');
    }
}


// NOTE: The following functions (save, delete) are simulations.
// They modify the local 'contents' array but don't persist permanently.
function saveItem(itemData) {
    if (isEditing) { // Update existing item
        const index = contents.findIndex(c => c.id == isEditing);
        if (index > -1) {
            const oldItem = { ...contents[index] };
            delete oldItem.revisions; // Avoid nesting revisions
            itemData.revisions = [oldItem, ...(contents[index].revisions || [])];
            contents[index] = { ...contents[index], ...itemData, lastModified: new Date().toISOString() };
        }
    } else { // Create new item
        const newItem = {
            id: Date.now(), // simple unique ID
            ...itemData,
            dateCreated: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            useCount: 0,
            revisions: []
        };
        contents.unshift(newItem);
    }
    toast('ok', `Item ${isEditing ? 'updated' : 'created'} successfully!`);
    resetForm();
    renderAll();
}

function deleteItem(id) {
    if (confirm('Are you sure you want to delete this item?')) {
        contents = contents.filter(c => c.id != id);
        toast('ok', 'Item deleted.');
        renderAll();
    }
}

// =================================================================================
// ===== RENDER & UI UPDATES =======================================================
// =================================================================================
function renderAll() {
    renderContentCards();
    renderCategoryDropdowns();
    updateUIVisibility();
}

function updateUIVisibility() {
    const authContainer = $('#auth-container');
    if (currentUser) {
        authContainer.innerHTML = `
            <div class="text-sm">Welcome, <strong class="font-bold">${escapeHtml(currentUser.username)}</strong>!</div>
            <button id="logoutBtn" class="px-3 py-2 rounded-lg bg-primary/20 hover:bg-primary/30 text-sm font-bold">Logout</button>
            <button id="themeToggle" class="p-2 rounded-full hover:bg-primary/10" title="Toggle theme"><span class="material-symbols-outlined">dark_mode</span></button>
        `;
        $('#logoutBtn').addEventListener('click', () => {
            logout();
            toast('ok', 'You have been logged out.');
        });
    } else {
        authContainer.innerHTML = `
            <button id="themeToggle" class="p-2 rounded-full hover:bg-primary/10" title="Toggle theme"><span class="material-symbols-outlined">dark_mode</span></button>
            <button id="loginBtn" class="px-4 py-2 rounded-lg bg-primary text-white hover:opacity-90 text-sm font-bold">Login</button>
        `;
        $('#loginBtn').addEventListener('click', () => openModal('loginModal'));
    }
    // Theme toggle needs to be re-attached if authContainer is overwritten
    $('#themeToggle').addEventListener('click', toggleTheme);

    // Toggle visibility of controls based on role
    const canCreate = hasPermission('editor');
    const canManage = hasPermission('admin');
    
    $('#addContentBtn').classList.toggle('hidden', !canCreate);
    $('#manageCategoriesBtn').classList.toggle('hidden', !canManage);
    $('#content-form-container').classList.toggle('hidden', !isEditing && !canCreate);

    if (!canCreate) {
      resetForm(); // Hide form if user logs out while it's open
    }
    
    renderContentCards();
}

function renderContentCards() {
    const grid = $('#contentGrid');
    const search = ($('#searchInput').value || '').toLowerCase();
    const cat = $('#categoryFilterSelect').value;

    const filtered = contents.filter(c =>
        (cat === 'all' || c.category === cat) &&
        (search === '' ||
         (c.title || '').toLowerCase().includes(search) ||
         (c.content || '').toLowerCase().includes(search) ||
         (c.tags || []).some(t => t.toLowerCase().includes(search)))
    );

    if (filtered.length === 0) {
        grid.innerHTML = `<div class="col-span-full border border-dashed rounded-lg p-8 text-center text-subtle-light dark:text-subtle-dark">No content found.</div>`;
        return;
    }

    const canEdit = hasPermission('editor');
    const canDelete = hasPermission('admin');

    grid.innerHTML = filtered.map(c => {
        const waHTML = toHTML(c.formattedContent || toWhatsApp(c.content));
        return `
        <div class="border rounded-lg p-4 flex flex-col bg-background-light dark:bg-background-dark border-border-light dark:border-border-dark">
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1">
                    <h3 class="font-semibold text-sm leading-tight line-clamp-2">${escapeHtml(c.title)}</h3>
                    <div class="mt-1"><span class="text-xs inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-primary/20 font-bold">${escapeHtml(c.category)}</span></div>
                </div>
                <div class="flex gap-1 shrink-0">
                    <button class="copyBtn p-2 rounded-lg border hover:bg-primary/10" title="Copy" data-id="${c.id}"><span class="material-symbols-outlined text-base">content_copy</span></button>
                </div>
            </div>
            <div class="mt-3 flex-1 min-h-0 rounded-lg border border-border-light dark:border-border-dark overflow-hidden">
                <div class="h-full max-h-48 overflow-auto p-3 text-sm scrollbar-thin whitespace-pre-wrap">${waHTML}</div>
            </div>
            ${ (c.tags && c.tags.length) ? `<div class="flex flex-wrap gap-1 mt-3">${c.tags.map(t => `<span class="px-2 py-0.5 rounded bg-black/5 dark:bg-white/10 text-xs">#${escapeHtml(t)}</span>`).join('')}</div>` : '' }
            <div class="text-xs text-subtle-light dark:text-subtle-dark flex justify-between mt-auto pt-3">
                <div class="flex gap-2">
                  ${ canEdit ? `<button class="editBtn flex items-center gap-1 hover:text-content-dark" data-id="${c.id}"><span class="material-symbols-outlined text-base">edit</span> Edit</button>` : '' }
                  ${ canDelete ? `<button class="deleteBtn flex items-center gap-1 hover:text-red-500" data-id="${c.id}"><span class="material-symbols-outlined text-base">delete</span> Delete</button>` : '' }
                  ${ (c.revisions && c.revisions.length) ? `<button class="historyBtn flex items-center gap-1 hover:text-content-dark" data-id="${c.id}"><span class="material-symbols-outlined text-base">history</span> History</button>` : ''}
                </div>
                <span>Used: ${c.useCount || 0}</span>
            </div>
        </div>`;
    }).join('');
}

function renderCategoryDropdowns() {
    const options = categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    $('#category').innerHTML = `<option value="">Select category</option>${options}`;
    $('#categoryFilterSelect').innerHTML = `<option value="all">All Categories</option>${options}`;
}

function renderCategoryManager() {
    $('#categoryList').innerHTML = categories.map(cat => `
        <div class="flex items-center gap-2 p-2 border rounded-lg">
            <input type="text" value="${escapeHtml(cat)}" data-original="${escapeHtml(cat)}" class="category-name-input flex-grow bg-transparent focus:outline-none">
            <button class="rename-cat-btn p-1 hover:text-primary" data-cat="${escapeHtml(cat)}"><span class="material-symbols-outlined text-base">save</span></button>
            <button class="delete-cat-btn p-1 hover:text-red-500" data-cat="${escapeHtml(cat)}"><span class="material-symbols-outlined text-base">delete</span></button>
        </div>
    `).join('');
}

function renderHistoryModal(item) {
    if (!item || !item.revisions || item.revisions.length === 0) {
        $('#historyList').innerHTML = `<p class="text-subtle-dark">No revision history for this item.</p>`;
        return;
    }
    $('#historyList').innerHTML = item.revisions.map((rev, i) => `
        <div class="border rounded-lg p-3">
            <p class="text-sm font-bold">Revision ${item.revisions.length - i} <span class="text-subtle-dark font-normal">(${new Date(rev.lastModified).toLocaleString()})</span></p>
            <h4 class="font-semibold mt-1">${escapeHtml(rev.title)}</h4>
            <div class="mt-2 text-sm whitespace-pre-wrap p-2 bg-black/5 dark:bg-white/5 rounded max-h-32 overflow-auto scrollbar-thin">${toHTML(rev.content)}</div>
        </div>
    `).join('');
    openModal('historyModal');
}


// =================================================================================
// ===== FORM HANDLING =============================================================
// =================================================================================
function showForm(itemToEdit = null) {
    $('#content-form-container').classList.remove('hidden');
    if (itemToEdit) {
        isEditing = itemToEdit.id;
        $('#formTitle').textContent = 'Edit Content';
        $('#editItemId').value = itemToEdit.id;
        $('#title').value = itemToEdit.title || '';
        $('#category').value = itemToEdit.category || '';
        $('#content').value = itemToEdit.content || '';
        $('#tags').value = (itemToEdit.tags || []).join(', ');
    } else {
        isEditing = null;
        $('#formTitle').textContent = 'Add New Content';
        $('#addForm').reset();
    }
    updateLivePreview();
    $('#addForm').scrollIntoView({ behavior: 'smooth' });
}

function resetForm() {
    isEditing = null;
    $('#addForm').reset();
    $('#content-form-container').classList.add('hidden');
    updateLivePreview();
}

function updateLivePreview() {
    $('#previewTitle').textContent = $('#title').value || '—';
    $('#waPreview').innerHTML = toHTML(toWhatsApp($('#content').value)) || '(start typing…)';
}

// =================================================================================
// ===== MODAL HANDLING ============================================================
// =================================================================================
function openModal(modalId) { $(`#${modalId}`).classList.remove('modal-hidden'); }
function closeModal(modalId) { $(`#${modalId}`).classList.add('modal-hidden'); }

// =================================================================================
// ===== THEME =====================================================================
// =================================================================================
const applyTheme = (mode) => { document.documentElement.classList.toggle('dark', mode === 'dark'); localStorage.setItem('theme', mode); };
const toggleTheme = () => { applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'); };

// =================================================================================
// ===== EVENT LISTENERS ===========================================================
// =================================================================================
document.addEventListener('DOMContentLoaded', () => {
    // Initial Setup
    checkSession();
    applyTheme(localStorage.getItem('theme') || 'dark');
    syncContents();

    // Header & Global Actions
    $('#syncBtn').addEventListener('click', syncContents);
    $('#addContentBtn').addEventListener('click', () => showForm());
    $('#manageCategoriesBtn').addEventListener('click', () => {
        renderCategoryManager();
        openModal('categoryModal');
    });

    // Filtering
    $('#searchInput').addEventListener('input', renderContentCards);
    $('#categoryFilterSelect').addEventListener('change', renderContentCards);
    $('#clearFilters').addEventListener('click', () => {
        $('#searchInput').value = '';
        $('#categoryFilterSelect').value = 'all';
        renderContentCards();
    });

    // Content Form
    $('#addForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = {
            title: $('#title').value,
            content: $('#content').value,
            formattedContent: toWhatsApp($('#content').value),
            category: $('#category').value,
            tags: $('#tags').value.split(',').map(t => t.trim()).filter(Boolean),
        };
        saveItem(formData);
    });
    $('#cancelBtn').addEventListener('click', resetForm);
    $('#title').addEventListener('input', updateLivePreview);
    $('#content').addEventListener('input', updateLivePreview);

    // Event Delegation for dynamic content
    document.body.addEventListener('click', (e) => {
        const copyBtn = e.target.closest('.copyBtn');
        const editBtn = e.target.closest('.editBtn');
        const deleteBtn = e.target.closest('.deleteBtn');
        const historyBtn = e.target.closest('.historyBtn');

        if (copyBtn) {
            const item = contents.find(c => c.id == copyBtn.dataset.id);
            if (item) {
                navigator.clipboard.writeText(item.formattedContent || item.content);
                item.useCount = (item.useCount || 0) + 1;
                renderContentCards();
                toast('ok', 'Copied to clipboard!');
            }
        }
        if (editBtn) {
            const item = contents.find(c => c.id == editBtn.dataset.id);
            if (item) showForm(item);
        }
        if (deleteBtn) {
            deleteItem(deleteBtn.dataset.id);
        }
        if (historyBtn) {
            const item = contents.find(c => c.id == historyBtn.dataset.id);
            if (item) renderHistoryModal(item);
        }
    });

    // Modal Handling
    $('#loginForm').addEventListener('submit', e => {
        e.preventDefault();
        if (login($('#username').value, $('#password').value)) {
            closeModal('loginModal');
            toast('ok', `Welcome, ${currentUser.username}!`);
        } else {
            toast('error', 'Invalid username or password.');
        }
    });
    $('#loginCancel').addEventListener('click', () => closeModal('loginModal'));
    $('#categoryClose').addEventListener('click', () => closeModal('categoryModal'));
    $('#historyClose').addEventListener('click', () => closeModal('historyModal'));
    
    // Category Manager
    $('#addCategoryForm').addEventListener('submit', e => {
        e.preventDefault();
        const newCat = $('#newCategoryName').value.trim();
        if (newCat && !categories.includes(newCat)) {
            categories.push(newCat);
            categories.sort();
            renderCategoryManager();
            renderCategoryDropdowns();
            $('#newCategoryName').value = '';
        }
    });
    
    $('#categoryList').addEventListener('click', e => {
        const delBtn = e.target.closest('.delete-cat-btn');
        const renBtn = e.target.closest('.rename-cat-btn');
        if (delBtn) {
            const catToDelete = delBtn.dataset.cat;
            if (confirm(`Delete "${catToDelete}"? Content using it will not be affected.`)) {
                categories = categories.filter(c => c !== catToDelete);
                renderCategoryManager();
                renderCategoryDropdowns();
            }
        }
        if (renBtn) {
            const oldName = renBtn.dataset.cat;
            const input = renBtn.parentElement.querySelector('.category-name-input');
            const newName = input.value.trim();
            if (newName && newName !== oldName) {
                const index = categories.indexOf(oldName);
                if (index > -1) {
                    categories[index] = newName;
                    categories.sort();
                    // Update content with the old category name
                    contents.forEach(c => { if (c.category === oldName) c.category = newName; });
                    toast('ok', `Category renamed to "${newName}"`);
                    renderAll();
                    renderCategoryManager();
                }
            } else {
                input.value = oldName; // revert if invalid
            }
        }
    });
});

</script>
</body>
</html>
