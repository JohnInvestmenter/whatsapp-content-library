<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp Content Library</title>
  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="icon" href="data:," />
  <style>
    /* Simple card + muted/secondary tokens to mimic shadcn/ui naming */
    :root{
      --bg:#0b0b0c; --card:#111113; --muted:#1a1a1d; --muted-foreground:#9ca3af; --foreground:#e5e7eb; --primary:#16a34a; --primary-foreground:#ecfdf5; --secondary:#0f766e; --secondary-foreground:#ecfeff;
    }
    body{background:var(--bg); color:var(--foreground)}
    .card{background:var(--card); border:1px solid rgba(255,255,255,0.06)}
    .bg-muted{background:var(--muted)}
    .text-muted-foreground{color:var(--muted-foreground)}
    .bg-primary{background:var(--primary)}
    .text-primary-foreground{color:var(--primary-foreground)}
    .bg-secondary{background:var(--secondary)}
    .text-secondary-foreground{color:var(--secondary-foreground)}
    .chip{border-radius:9999px; padding:2px 8px; font-size:12px}
    .btn{display:inline-flex; align-items:center; gap:.5rem; border:1px solid rgba(255,255,255,.12); padding:.5rem .75rem; border-radius:.75rem}
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.primary{background:var(--primary); border-color:transparent; color:#08140d}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.ghost{background:transparent}
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:1rem; z-index:50}
    .modal.show{display:flex}
    .input, .select, .textarea{width:100%; background:#0e0e10; border:1px solid rgba(255,255,255,.12); color:var(--foreground); padding:.6rem .8rem; border-radius:.6rem}
    .textarea{min-height:160px}
    pre{white-space:pre-wrap}
    .line-clamp-4{display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden}
  </style>
</head>
<body class="min-h-screen p-4">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 class="text-3xl font-bold flex items-center gap-2">
            <i data-lucide="message-circle" class="w-8 h-8 text-green-500"></i>
            WhatsApp Content Library
          </h1>
          <p class="text-muted-foreground mt-1">Manage your weekly group content with Notion integration</p>
        </div>
        <div class="flex gap-2">
          <button id="settingsBtn" class="btn"><i data-lucide="settings" class="w-4 h-4"></i>Settings</button>
          <button id="addBtn" class="btn primary"><i data-lucide="plus" class="w-4 h-4"></i>Add Content</button>
        </div>
      </div>
    </div>

    <!-- Notion Connection Status -->
    <div class="mb-6 card rounded-xl">
      <div class="p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div id="notionDot" class="w-3 h-3 rounded-full bg-red-500"></div>
          <span class="font-medium">Notion Integration: <span id="notionStatus">Not Connected</span></span>
        </div>
        <button id="syncBtn" class="btn" style="display:none">Sync Now</button>
      </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="mb-6 card rounded-xl hidden">
      <div class="p-4 border-b border-white/10">
        <h2 class="text-xl font-semibold">Notion Configuration</h2>
      </div>
      <div class="p-4 space-y-4">
        <div>
          <label for="apiKey" class="block mb-1 text-sm">Notion API Key</label>
          <input id="apiKey" type="password" class="input" placeholder="secret_..." />
        </div>
        <div>
          <label for="databaseId" class="block mb-1 text-sm">Database ID</label>
          <input id="databaseId" class="input" placeholder="Database ID from Notion" />
        </div>
        <div class="flex gap-2">
          <button id="connectBtn" class="btn primary">Connect to Notion</button>
          <button id="closeSettingsBtn" class="btn">Close</button>
        </div>
        <div class="text-sm text-muted-foreground">
          <p>To set up Notion integration:</p>
          <ol class="list-decimal list-inside mt-1 space-y-1">
            <li>Create a Notion integration at notion.so/integrations</li>
            <li>Copy your API key and paste it above</li>
            <li>Create a database and copy its ID</li>
            <li>Share your database with your integration</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Search & Filter -->
    <div class="mb-6 card rounded-xl">
      <div class="p-4 flex flex-col md:flex-row gap-4">
        <div class="flex-1 relative">
          <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground"></i>
          <input id="searchInput" class="input pl-10" placeholder="Search content, titles, or tags..." />
        </div>
        <div>
          <select id="categorySelect" class="select w-56"></select>
        </div>
      </div>
    </div>

    <!-- Cards Grid -->
    <div id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-12 hidden">
      <i data-lucide="message-circle" class="w-16 h-16 text-muted-foreground mx-auto mb-4"></i>
      <h3 class="text-xl font-semibold mb-2">No content found</h3>
      <p id="emptyHint" class="text-muted-foreground mb-4"></p>
      <button class="btn primary" id="emptyAddBtn"><i data-lucide="plus" class="w-4 h-4"></i>Add Your First Content</button>
    </div>

    <!-- Stats -->
    <div class="mt-8 card rounded-xl">
      <div class="p-4 border-b border-white/10"><h3 class="text-lg font-semibold">Content Statistics</h3></div>
      <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="text-center">
          <div id="statTotal" class="text-2xl font-bold text-green-400">0</div>
          <div class="text-sm text-muted-foreground">Total Content</div>
        </div>
        <div class="text-center">
          <div id="statUses" class="text-2xl font-bold text-green-400">0</div>
          <div class="text-sm text-muted-foreground">Total Uses</div>
        </div>
        <div class="text-center">
          <div id="statCats" class="text-2xl font-bold text-green-400">0</div>
          <div class="text-sm text-muted-foreground">Categories</div>
        </div>
        <div class="text-center">
          <div id="statRecent" class="text-2xl font-bold text-green-400">0</div>
          <div class="text-sm text-muted-foreground">Recently Used</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Editor Modal -->
  <div id="editorModal" class="modal">
    <div class="card rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-white/10"><h3 class="text-xl font-semibold">Add New Content</h3></div>
      <div class="p-4 space-y-4">
        <div>
          <label class="block mb-1 text-sm" for="newTitle">Title</label>
          <input id="newTitle" class="input" placeholder="Content title..." />
        </div>
        <div>
          <label class="block mb-1 text-sm" for="newCategory">Category</label>
          <select id="newCategory" class="select"></select>
        </div>
        <div>
          <label class="block mb-1 text-sm" for="newContent">Content</label>
          <textarea id="newContent" class="textarea" placeholder="Enter your content here. Use **bold**, __italic__, ~~strikethrough~~, and `code` formatting."></textarea>
        </div>
        <div>
          <label class="block mb-1 text-sm" for="newTags">Tags (comma separated)</label>
          <input id="newTags" class="input" placeholder="motivation, weekly, inspiration" />
        </div>
        <div id="waPreviewWrap" class="hidden">
          <label class="block mb-1 text-sm">WhatsApp Preview</label>
          <div class="bg-muted p-3 rounded-md">
            <pre id="waPreview" class="font-sans text-sm"></pre>
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button id="cancelEditor" class="btn">Cancel</button>
          <button id="saveEditor" class="btn primary">Add Content</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== Data & State ======
    const LS_KEY = 'whatsappContent';
    const NOTION_KEY = 'notionConfig';

    const sampleContents = [
      {
        id: '1',
        title: 'Weekly Motivation',
        content: "Start your week with determination! Remember that every small step counts toward your bigger goals. You've got this! ðŸ’ª",
        formattedContent: '*Start your week with determination!* \n\nRemember that every small step counts toward your bigger goals. \n\n*You\'ve got this!* ðŸ’ª',
        category: 'Motivation',
        tags: ['weekly','inspiration','goals'],
        dateCreated: '2024-01-15',
        useCount: 12,
        lastUsed: '2024-01-08'
      },
      {
        id: '2',
        title: 'Tech Tips Tuesday',
        content: 'Did you know? You can schedule WhatsApp messages by typing your message and holding the send button! Perfect for sending reminders or birthday wishes.',
        formattedContent: '*ðŸ”§ Tech Tips Tuesday* \n\n*Did you know?* \nYou can schedule WhatsApp messages by typing your message and holding the send button! \n\nPerfect for: \nâ€¢ Sending reminders \nâ€¢ Birthday wishes \nâ€¢ Important announcements',
        category: 'Tech Tips',
        tags: ['technology','whatsapp','productivity'],
        dateCreated: '2024-01-10',
        useCount: 8,
        lastUsed: '2024-01-02'
      },
      {
        id: '3',
        title: 'Friday Fun Facts',
        content: 'Fun Fact Friday! The shortest war in history lasted only 38-45 minutes. It was between Britain and Zanzibar in 1896. Sometimes quick decisions work out!',
        formattedContent: '*ðŸŽ‰ Fun Fact Friday!* \n\nThe shortest war in history lasted only *38-45 minutes*. \n\nIt was between Britain and Zanzibar in 1896. \n\n_Sometimes quick decisions work out!_ ðŸ˜„',
        category: 'Fun Facts',
        tags: ['friday','history','trivia'],
        dateCreated: '2024-01-05',
        useCount: 15,
        lastUsed: '2024-01-05'
      }
    ];

    const categories = ['All Categories','Motivation','Tech Tips','Fun Facts','Announcements','Events','Educational'];

    let contents = [];
    let filtered = [];
    let searchQuery = '';
    let selectedCategory = 'all';

    // ====== Helpers ======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const formatForWhatsApp = (text) => {
      return text
        .replace(/\*\*(.*?)\*\*/g, '*$1*') // Bold
        .replace(/__(.*?)__/g, '_$1_')        // Italic
        .replace(/~~(.*?)~~/g, '~$1~')        // Strike
        .replace(/`(.*?)`/g, '$1');           // Inline code strip
    };

    const saveLS = () => localStorage.setItem(LS_KEY, JSON.stringify(contents));

    const loadLS = () => {
      const saved = localStorage.getItem(LS_KEY);
      contents = saved ? JSON.parse(saved) : sampleContents;
      filtered = contents.slice();
    };

    const sumUses = arr => arr.reduce((s,c) => s + (c.useCount||0), 0);

    const uniqueCats = arr => new Set(arr.map(c=>c.category)).size;

    const renderStats = () => {
      $('#statTotal').textContent = contents.length;
      $('#statUses').textContent = sumUses(contents);
      $('#statCats').textContent = uniqueCats(contents);
      $('#statRecent').textContent = contents.filter(c=>c.lastUsed).length;
    };

    const renderCategorySelects = () => {
      const catSel = $('#categorySelect');
      catSel.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = 'all'; optAll.textContent = 'All Categories';
      catSel.appendChild(optAll);
      categories.filter(c=>c!=='All Categories').forEach(cat=>{
        const o = document.createElement('option'); o.value = cat; o.textContent = cat; catSel.appendChild(o);
      });

      const modalSel = $('#newCategory');
      modalSel.innerHTML = '';
      categories.filter(c=>c!=='All Categories').forEach(cat=>{
        const o = document.createElement('option'); o.value = cat; o.textContent = cat; modalSel.appendChild(o);
      });
    };

    const applyFilter = () => {
      let arr = contents.slice();
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        arr = arr.filter(c =>
          c.title.toLowerCase().includes(q) ||
          c.content.toLowerCase().includes(q) ||
          (c.tags||[]).some(t=>t.toLowerCase().includes(q))
        );
      }
      if (selectedCategory !== 'all') {
        arr = arr.filter(c => c.category === selectedCategory);
      }
      filtered = arr;
    };

    const setEmptyState = () => {
      const none = filtered.length === 0;
      $('#emptyState').classList.toggle('hidden', !none);
      $('#cardsGrid').classList.toggle('hidden', none);
      const hint = (searchQuery || selectedCategory !== 'all') ? 'Try adjusting your search or filters' : 'Start by adding your first piece of content';
      $('#emptyHint').textContent = hint;
    };

    const icon = (name, cls='w-4 h-4') => `<i data-lucide="${name}" class="${cls}"></i>`;

    const renderCards = () => {
      const grid = $('#cardsGrid');
      grid.innerHTML = '';
      filtered.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card rounded-xl hover:shadow-lg/10 transition-shadow';
        card.innerHTML = `
          <div class="p-4 border-b border-white/10">
            <div class="flex justify-between items-start">
              <div>
                <div class="text-lg font-semibold">${escapeHtml(item.title)}</div>
                <div class="flex items-center gap-2 mt-1">
                  <span class="chip bg-primary text-primary-foreground">${escapeHtml(item.category)}</span>
                  <span class="text-muted-foreground text-xs flex items-center gap-1">${icon('bar-chart-3','w-3 h-3')} Used ${item.useCount||0} times</span>
                </div>
              </div>
              <div class="flex gap-1">
                <button class="btn ghost copyBtn" title="Copy"><i data-lucide="copy" class="w-4 h-4 text-green-400"></i></button>
                <button class="btn ghost delBtn" title="Delete"><i data-lucide="trash" class="w-4 h-4 text-red-400"></i></button>
              </div>
            </div>
          </div>
          <div class="p-4">
            <div class="space-y-3">
              <div class="bg-muted p-3 rounded-md">
                <pre class="text-sm font-sans line-clamp-4">${escapeHtml(item.formattedContent)}</pre>
              </div>
              <div class="flex flex-wrap gap-1">
                ${(item.tags||[]).map(t=>`<span class="chip bg-secondary text-secondary-foreground flex items-center gap-1">${icon('tag','w-3 h-3')}${escapeHtml(t)}</span>`).join('')}
              </div>
              <div class="flex justify-between items-center text-xs text-muted-foreground">
                <span class="flex items-center gap-1">${icon('calendar','w-3 h-3')} Created: ${item.dateCreated}</span>
                ${item.lastUsed ? `<span>Last used: ${item.lastUsed}</span>` : ''}
              </div>
            </div>
            <button class="btn primary w-full mt-3 copyBtn">${icon('copy')} Copy for WhatsApp</button>
          </div>
        `;
        // bind actions
        card.querySelectorAll('.copyBtn').forEach(btn=>btn.addEventListener('click',()=>copyContent(item.id)));
        card.querySelector('.delBtn').addEventListener('click',()=>deleteContent(item.id));
        grid.appendChild(card);
      });
      lucide.createIcons();
    };

    const escapeHtml = (str='') => str
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;');

    const nowISODate = () => new Date().toISOString().split('T')[0];

    async function copyContent(id){
      const item = contents.find(c=>c.id===id);
      if(!item) return;
      try{
        await navigator.clipboard.writeText(item.formattedContent);
        // update use count + last used
        item.useCount = (item.useCount||0) + 1;
        item.lastUsed = nowISODate();
        saveLS();
        applyFilter();
        renderCards();
        renderStats();
        alert('Content copied to clipboard!');
      }catch(e){
        console.error(e); alert('Failed to copy content. Please try again.');
      }
    }

    function deleteContent(id){
      if(!confirm('Are you sure you want to delete this content?')) return;
      contents = contents.filter(c=>c.id!==id);
      saveLS();
      applyFilter();
      renderCards();
      renderStats();
      setEmptyState();
    }

    function openEditor(open=true){
      $('#editorModal').classList.toggle('show', open);
    }

    function resetEditor(){
      $('#newTitle').value = '';
      $('#newCategory').value = categories[1];
      $('#newContent').value = '';
      $('#newTags').value = '';
      $('#waPreviewWrap').classList.add('hidden');
      $('#waPreview').textContent = '';
    }

    function addContent(){
      const title = $('#newTitle').value.trim();
      const category = $('#newCategory').value || 'General';
      const content = $('#newContent').value.trim();
      const tagsRaw = $('#newTags').value.trim();
      if(!title || !content){ alert('Please fill in both title and content.'); return; }
      const item = {
        id: String(Date.now()),
        title,
        content,
        formattedContent: formatForWhatsApp(content),
        category,
        tags: tagsRaw ? tagsRaw.split(',').map(t=>t.trim()).filter(Boolean) : [],
        dateCreated: nowISODate(),
        useCount: 0
      };
      contents.push(item);
      saveLS();
      applyFilter();
      renderCards();
      renderStats();
      setEmptyState();
      openEditor(false);
      alert('Content added successfully!');
      // (Optional) Notion sync simulation
      if(isConnected()) console.log('Syncing new content to Notion:', item);
    }

    // ====== Notion Config ======
    function loadNotionConfig(){
      const s = localStorage.getItem(NOTION_KEY);
      return s ? JSON.parse(s) : { apiKey:'', databaseId:'' };
    }
    function saveNotionConfig(cfg){ localStorage.setItem(NOTION_KEY, JSON.stringify(cfg)); }
    function isConnected(){
      const {apiKey,databaseId} = loadNotionConfig();
      return Boolean(apiKey && databaseId);
    }
    function renderNotionStatus(){
      const connected = isConnected();
      $('#notionDot').className = 'w-3 h-3 rounded-full ' + (connected ? 'bg-green-500':'bg-red-500');
      $('#notionStatus').textContent = connected ? 'Connected' : 'Not Connected';
      $('#syncBtn').style.display = connected ? '' : 'none';
      const cfg = loadNotionConfig();
      $('#apiKey').value = cfg.apiKey || '';
      $('#databaseId').value = cfg.databaseId || '';
    }

    // ====== Event Wiring ======
    function wireEvents(){
      $('#addBtn').addEventListener('click', ()=>{ resetEditor(); openEditor(true); });
      $('#emptyAddBtn').addEventListener('click', ()=>{ resetEditor(); openEditor(true); });
      $('#cancelEditor').addEventListener('click', ()=>openEditor(false));
      $('#saveEditor').addEventListener('click', addContent);

      $('#newContent').addEventListener('input', (e)=>{
        const v = e.target.value.trim();
        if(v){
          $('#waPreviewWrap').classList.remove('hidden');
          $('#waPreview').textContent = formatForWhatsApp(v);
        }else{
          $('#waPreviewWrap').classList.add('hidden');
        }
      });

      $('#settingsBtn').addEventListener('click', ()=>{
        $('#settingsPanel').classList.toggle('hidden');
      });
      $('#closeSettingsBtn').addEventListener('click', ()=>$('#settingsPanel').classList.add('hidden'));

      $('#connectBtn').addEventListener('click', ()=>{
        const cfg = { apiKey: $('#apiKey').value.trim(), databaseId: $('#databaseId').value.trim() };
        if(!cfg.apiKey || !cfg.databaseId){ alert('Please fill both API Key and Database ID.'); return; }
        saveNotionConfig(cfg);
        renderNotionStatus();
        alert('Successfully synced with Notion database!');
      });

      $('#syncBtn').addEventListener('click', ()=>{
        console.log('Syncing with Notion...', loadNotionConfig());
        alert('Sync simulated. (Hook up real Notion API in a backend if needed)');
      });

      $('#searchInput').addEventListener('input', (e)=>{
        searchQuery = e.target.value; applyFilter(); renderCards(); setEmptyState();
      });
      $('#categorySelect').addEventListener('change', (e)=>{
        selectedCategory = e.target.value; applyFilter(); renderCards(); setEmptyState();
      });
    }

    // ====== Boot ======
    function boot(){
      loadLS();
      renderCategorySelects();
      applyFilter();
      renderCards();
      setEmptyState();
      renderStats();
      renderNotionStatus();
      wireEvents();
      // defaults in editor
      $('#newCategory').value = categories[1];
      lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
