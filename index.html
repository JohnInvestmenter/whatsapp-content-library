<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InvestMenter – Content Library</title>
  <link rel="icon" href="https://onecdn.io/media/ffb500c6-8305-4802-8cf9-6b55e6bd5ed5/md2x" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* ---------- THEME ---------- */
    :root{
      --ink:#0b0b0c; --fg:#0b0b0c; --muted:#f4f5f7; --muted-ink:#6b7280;
      --brand:#d6b160; --brand-ink:#000; --chip:#0f766e; --chip-ink:#ecfeff;
      --card:#ffffff; --border:rgba(0,0,0,.08); --bg:#ffffff;
      --wa:#e7f1e9; --wa-ink:#0b0b0c;
      --prompt:#f0f4ff; --prompt-ink:#0b0b0c;
    }
    [data-theme="dark"]{
      --ink:#e5e7eb; --fg:#e5e7eb; --muted:#16181b; --muted-ink:#9ca3af;
      --brand:#d6b160; --brand-ink:#000; --chip:#0d9488; --chip-ink:#ecfeff;
      --card:#0f1114; --border:rgba(255,255,255,.10); --bg:#0b0b0c;
      --wa:#0f1a13; --wa-ink:#e5e7eb;
      --prompt:#1a1f2e; --prompt-ink:#e5e7eb;
    }
    body{ background:var(--bg); color:var(--fg); }
    .card{ background:var(--card); border:1px solid var(--border); }
    .chip{ border-radius:9999px; padding:2px 8px; font-size:12px }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--border); padding:.55rem .8rem; border-radius:.75rem; cursor:pointer; }
    .btn:hover:not([disabled]){ background:rgba(255,255,255,.06) }
    [data-theme="light"] .btn:hover:not([disabled]){ background:rgba(0,0,0,.04) }
    .btn-brand{ background:var(--brand); color:var(--brand-ink); border-color:transparent; }
    .btn-brand:hover:not([disabled]){ filter:brightness(.95) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .shadow-soft{ box-shadow:0 8px 30px rgba(0,0,0,.12) }
    [data-theme="dark"] .shadow-soft{ box-shadow:0 8px 30px rgba(0,0,0,.35) }
    .scrollbar-thin{ scrollbar-width: thin; }
    .scrollbar-thin::-webkit-scrollbar{ height:6px; width:6px;}
    .scrollbar-thin::-webkit-scrollbar-thumb{ background:rgba(127,127,127,.35); border-radius:999px;}
    .wa-bubble { background:var(--wa); color:var(--wa-ink); border:1px solid var(--border); border-radius:12px; padding:12px; }
    .wa-bubble strong{ font-weight:700; }
    .wa-bubble em{ font-style:italic; }
    .wa-bubble s{ text-decoration:line-through; }
    .wa-bubble code{
      background:transparent; border:1px solid var(--border); border-radius:6px; padding:1px 4px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.875em;
    }
    .prompt-bubble { background:var(--prompt); color:var(--prompt-ink); border:1px solid var(--border); border-radius:12px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:.875em; white-space: pre-wrap; }
    /* ---------- compact buttons ---------- */
    .btn-sm{ padding:.35rem .55rem; border-radius:.6rem; font-size:12px; gap:.35rem; line-height:1; }
    .btn-xs{ padding:.25rem .45rem; border-radius:.5rem; font-size:11px; gap:.3rem; line-height:1; }
    .btn-sm .lucide, .btn-xs .lucide{ width:16px; height:16px; }
    /* ---------- TABS ---------- */
    .tab{ padding:.75rem 1.5rem; border-bottom:2px solid transparent; cursor:pointer; transition:all .2s; }
    .tab:hover{ background:rgba(0,0,0,.04); }
    [data-theme="dark"] .tab:hover{ background:rgba(255,255,255,.06); }
    .tab.active{ border-bottom-color:var(--brand); font-weight:600; }
    .hidden{ display:none !important; }
    /* ---------- TUTORIAL ---------- */
    .tutorial-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:9999; display:none; }
    .tutorial-overlay.active{ display:block; }
    .tutorial-highlight{ position:absolute; box-shadow:0 0 0 9999px rgba(0,0,0,.85); border:3px solid var(--brand); border-radius:12px; z-index:10000; transition:all .3s ease; pointer-events:none; }
    .tutorial-tooltip{ position:absolute; background:var(--card); border:2px solid var(--brand); border-radius:12px; padding:20px; max-width:400px; z-index:10001; box-shadow:0 10px 40px rgba(0,0,0,.3); }
    .tutorial-arrow{ position:absolute; width:0; height:0; border:12px solid transparent; }
    .tutorial-arrow.top{ border-bottom-color:var(--brand); top:-24px; left:50%; transform:translateX(-50%); }
    .tutorial-arrow.bottom{ border-top-color:var(--brand); bottom:-24px; left:50%; transform:translateX(-50%); }
    .tutorial-arrow.left{ border-right-color:var(--brand); left:-24px; top:50%; transform:translateY(-50%); }
    .tutorial-arrow.right{ border-left-color:var(--brand); right:-24px; top:50%; transform:translateY(-50%); }
  </style>
</head>
<body class="min-h-screen p-6">
<div class="max-w-7xl mx-auto space-y-6">

  <!-- Header -->
  <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div class="flex items-center gap-3">
      <button id="tutorialBtn" class="btn btn-brand"><i data-lucide="help-circle"></i><span class="hidden md:inline">Tutorial</span></button>
      <h1 class="text-3xl font-bold flex items-center gap-2 tracking-tight">
        <i data-lucide="library"></i> Content Library
      </h1>
    </div>
    <div class="flex gap-2">
      <button id="supportBtn" class="btn"><i data-lucide="life-buoy"></i><span class="hidden md:inline">Support</span></button>
      <button id="themeBtn" class="btn"><i data-lucide="moon"></i><span class="hidden md:inline">Dark</span></button>
    </div>
  </header>

  <!-- Tabs -->
  <div class="card rounded-xl shadow-soft flex border-b-0">
    <div class="tab active" data-tab="whatsapp">
      <i data-lucide="message-circle"></i> WhatsApp Content
    </div>
    <div class="tab" data-tab="prompts">
      <i data-lucide="cpu"></i> GPT Prompts
    </div>
  </div>

  <!-- ==================== WHATSAPP SECTION ==================== -->
  <div id="whatsapp-section" class="tab-content">

    <!-- Toolbar -->
    <section class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex gap-2 w-full md:w-auto">
        <input id="wa-searchInput" placeholder="Search..." class="flex-1 p-3 rounded-lg border border-[var(--border)] bg-transparent"/>
        <select id="wa-categorySelect" class="p-3 rounded-lg border border-[var(--border)] bg-transparent">
          <option value="all">All Categories</option>
        </select>
      </div>
      <div class="flex gap-2 items-center">
        <button id="wa-syncBtn" class="btn"><i data-lucide="refresh-cw"></i><span class="hidden md:inline">Sync</span></button>
        <button id="wa-addBtn" class="btn btn-brand"><i data-lucide="plus"></i><span class="hidden md:inline">Add Content</span></button>
      </div>
    </section>

    <!-- Grid -->
    <section>
      <div id="wa-contentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch"></div>
      <div class="flex items-center justify-between mt-4">
        <button id="wa-prevPage" class="btn" disabled><i data-lucide="chevron-left"></i> Prev</button>
        <div class="text-sm text-[var(--muted-ink)]">Page <span id="wa-pageNum">1</span> of <span id="wa-pageCount">1</span></div>
        <button id="wa-nextPage" class="btn">Next <i data-lucide="chevron-right"></i></button>
      </div>
    </section>

    <!-- Stats -->
    <section class="card rounded-xl p-4 shadow-soft">
      <h2 class="font-semibold mb-2">Content Statistics</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div><div id="wa-statTotal" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Total Content</div></div>
        <div><div id="wa-statUses" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Total Uses</div></div>
        <div><div id="wa-statCategories" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Categories</div></div>
        <div><div id="wa-statRecent" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Recently Used</div></div>
      </div>
    </section>
  </div>

  <!-- ==================== GPT PROMPTS SECTION ==================== -->
  <div id="prompts-section" class="tab-content hidden">

    <!-- Toolbar -->
    <section class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex gap-2 w-full md:w-auto">
        <input id="gpt-searchInput" placeholder="Search prompts..." class="flex-1 p-3 rounded-lg border border-[var(--border)] bg-transparent"/>
        <select id="gpt-categorySelect" class="p-3 rounded-lg border border-[var(--border)] bg-transparent">
          <option value="all">All Categories</option>
        </select>
      </div>
      <div class="flex gap-2 items-center">
        <button id="gpt-syncBtn" class="btn"><i data-lucide="refresh-cw"></i><span class="hidden md:inline">Sync</span></button>
        <button id="gpt-addBtn" class="btn btn-brand"><i data-lucide="plus"></i><span class="hidden md:inline">Add Prompt</span></button>
      </div>
    </section>

    <!-- Grid -->
    <section>
      <div id="gpt-contentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch"></div>
      <div class="flex items-center justify-between mt-4">
        <button id="gpt-prevPage" class="btn" disabled><i data-lucide="chevron-left"></i> Prev</button>
        <div class="text-sm text-[var(--muted-ink)]">Page <span id="gpt-pageNum">1</span> of <span id="gpt-pageCount">1</span></div>
        <button id="gpt-nextPage" class="btn">Next <i data-lucide="chevron-right"></i></button>
      </div>
    </section>

    <!-- Stats -->
    <section class="card rounded-xl p-4 shadow-soft">
      <h2 class="font-semibold mb-2">Prompts Statistics</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div><div id="gpt-statTotal" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Total Prompts</div></div>
        <div><div id="gpt-statUses" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Total Uses</div></div>
        <div><div id="gpt-statCategories" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Categories</div></div>
        <div><div id="gpt-statRecent" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Recently Used</div></div>
      </div>
    </section>
  </div>

</div>

<!-- ==================== WHATSAPP MODALS ==================== -->

<!-- WA Edit Modal -->
<div id="wa-editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
  <div class="card w-full max-w-2xl rounded-xl shadow-soft flex flex-col max-h-[90vh]">
    <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
      <h2 class="text-xl font-semibold">Edit Content</h2>
      <button id="wa-editClose" class="btn"><i data-lucide="x"></i></button>
    </div>
    <div class="p-4 space-y-4 overflow-y-auto scrollbar-thin" style="max-height:60vh">
      <div><label class="block text-sm mb-1">Title</label><input id="wa-editTitle" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"/></div>
      <div><label class="block text-sm mb-1">Category</label><select id="wa-editCategory" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"></select></div>
      <div><label class="block text-sm mb-1">Content</label><textarea id="wa-editContent" rows="8" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"></textarea></div>
      <div><label class="block text-sm mb-1">Tags (comma separated)</label><input id="wa-editTags" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"/></div>
      <div><label class="block text-sm mb-1">WhatsApp Preview</label><div class="rounded-lg border border-[var(--border)] bg-[var(--muted)] p-2"><div id="wa-editPreview" class="wa-bubble text-sm max-h-48 overflow-auto whitespace-pre-wrap scrollbar-thin"></div></div></div>
    </div>
    <div class="p-4 border-t border-[var(--border)] flex justify-end gap-2">
      <button id="wa-editCancel" class="btn">Cancel</button>
      <button id="wa-editSave" class="btn btn-brand"><span id="wa-editSaveText">Save changes</span></button>
    </div>
  </div>
</div>

<!-- WA Add Modal -->
<div id="wa-addModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
  <div class="card w-full max-w-2xl rounded-xl shadow-soft flex flex-col max-h-[90vh]">
    <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
      <h2 class="text-xl font-semibold">Add New Content</h2>
      <button id="wa-addClose" class="btn"><i data-lucide="x"></i></button>
    </div>
    <div class="p-4 space-y-4 overflow-y-auto scrollbar-thin" style="max-height:60vh">
      <div><label class="block text-sm mb-1">Title</label><input id="wa-titleInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent" placeholder="Content title..."/></div>
      <div><label class="block text-sm mb-1">Category</label><select id="wa-categoryInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"></select></div>
      <div><label class="block text-sm mb-1">Content</label><textarea id="wa-contentInput" rows="8" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent" placeholder="Use **bold**, _italic_, ~strikethrough~, and `inline code`."></textarea></div>
      <div><label class="block text-sm mb-1">Tags (comma separated)</label><input id="wa-tagsInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent" placeholder="motivation, weekly, inspiration"/></div>
      <div><label class="block text-sm mb-1">WhatsApp Preview</label><div class="rounded-lg border border-[var(--border)] bg-[var(--muted)] p-2"><div id="wa-waPreview" class="wa-bubble text-sm max-h-48 overflow-auto whitespace-pre-wrap scrollbar-thin">(start typing above)</div></div></div>
    </div>
    <div class="p-4 border-t border-[var(--border)] flex justify-end gap-2">
      <button id="wa-clearAdd" class="btn"><i data-lucide="eraser"></i> Clear</button>
      <button id="wa-cancelAdd" class="btn">Cancel</button>
      <button id="wa-saveAdd" class="btn btn-brand" disabled><span id="wa-saveAddText">Save</span></button>
    </div>
  </div>
</div>

<!-- WA Send Modal -->
<div id="wa-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
  <div class="card w-full max-w-md rounded-xl shadow-soft p-4">
    <h3 class="text-xl font-semibold mb-4">Send via WhatsApp</h3>
    <label class="block text-sm mb-2">Phone number (international, digits only)</label>
    <input id="wa-phone" type="tel" placeholder="9715XXXXXXXX" class="w-full p-3 rounded-lg border border-[var(--border)] bg-transparent mb-4"/>
    <label class="block text-sm mb-2">Message</label>
    <textarea id="wa-text" rows="6" class="w-full p-3 rounded-lg border border-[var(--border)] bg-transparent resize-vertical mb-4"></textarea>
    <div class="flex gap-2 justify-end">
      <button id="wa-cancel" class="btn">Cancel</button>
      <button id="wa-send" class="btn btn-brand">Send</button>
    </div>
  </div>
</div>

<!-- ==================== GPT PROMPTS MODALS ==================== -->

<!-- GPT Edit Modal -->
<div id="gpt-editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
  <div class="card w-full max-w-3xl rounded-xl shadow-soft flex flex-col max-h-[90vh]">
    <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
      <h2 class="text-xl font-semibold">Edit Prompt</h2>
      <button id="gpt-editClose" class="btn"><i data-lucide="x"></i></button>
    </div>
    <div class="p-4 space-y-4 overflow-y-auto scrollbar-thin" style="max-height:60vh">
      <div><label class="block text-sm mb-1">Title</label><input id="gpt-editTitle" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"/></div>
      <div class="grid grid-cols-2 gap-3">
        <div><label class="block text-sm mb-1">Category</label><select id="gpt-editCategory" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"></select></div>
        <div><label class="block text-sm mb-1">Model</label><select id="gpt-editModel" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"><option>GPT-4</option><option>GPT-4-Turbo</option><option>GPT-3.5</option></select></div>
      </div>
      <div><label class="block text-sm mb-1">System Role (optional)</label><textarea id="gpt-editSystemRole" rows="3" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent" placeholder="You are a helpful assistant..."></textarea></div>
      <div><label class="block text-sm mb-1">Prompt</label><textarea id="gpt-editPrompt" rows="6" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"></textarea></div>
      <div><label class="block text-sm mb-1">Tags (comma separated)</label><input id="gpt-editTags" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"/></div>
    </div>
    <div class="p-4 border-t border-[var(--border)] flex justify-end gap-2">
      <button id="gpt-editCancel" class="btn">Cancel</button>
      <button id="gpt-editSave" class="btn btn-brand"><span id="gpt-editSaveText">Save changes</span></button>
    </div>
  </div>
</div>

<!-- GPT Add Modal -->
<div id="gpt-addModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
  <div class="card w-full max-w-3xl rounded-xl shadow-soft flex flex-col max-h-[90vh]">
    <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
      <h2 class="text-xl font-semibold">Add New Prompt</h2>
      <button id="gpt-addClose" class="btn"><i data-lucide="x"></i></button>
    </div>
    <div class="p-4 space-y-4 overflow-y-auto scrollbar-thin" style="max-height:60vh">
      <div><label class="block text-sm mb-1">Title</label><input id="gpt-titleInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent" placeholder="Prompt title..."/></div>
      <div class="grid grid-cols-2 gap-3">
        <div><label class="block text-sm mb-1">Category</label><select id="gpt-categoryInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"></select></div>
        <div><label class="block text-sm mb-1">Model</label><select id="gpt-modelInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent"><option>GPT-4</option><option>GPT-4-Turbo</option><option>GPT-3.5</option></select></div>
      </div>
      <div><label class="block text-sm mb-1">System Role (optional)</label><textarea id="gpt-systemRoleInput" rows="3" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent" placeholder="You are a helpful assistant..."></textarea></div>
      <div><label class="block text-sm mb-1">Prompt</label><textarea id="gpt-promptInput" rows="6" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent" placeholder="Enter your GPT prompt..."></textarea></div>
      <div><label class="block text-sm mb-1">Tags (comma separated)</label><input id="gpt-tagsInput" class="w-full p-2 rounded-lg border border-[var(--border)] bg-transparent" placeholder="sales, email, marketing"/></div>
    </div>
    <div class="p-4 border-t border-[var(--border)] flex justify-end gap-2">
      <button id="gpt-clearAdd" class="btn"><i data-lucide="eraser"></i> Clear</button>
      <button id="gpt-cancelAdd" class="btn">Cancel</button>
      <button id="gpt-saveAdd" class="btn btn-brand" disabled><span id="gpt-saveAddText">Save</span></button>
    </div>
  </div>
</div>

<!-- ==================== TUTORIAL ==================== -->
<div id="tutorialOverlay" class="tutorial-overlay">
  <div id="tutorialHighlight" class="tutorial-highlight"></div>
  <div id="tutorialTooltip" class="tutorial-tooltip">
    <div id="tutorialArrow" class="tutorial-arrow"></div>
    <h3 class="text-lg font-bold mb-2" id="tutorialTitle"></h3>
    <p class="text-sm mb-4" id="tutorialText"></p>
    <div class="flex items-center justify-between">
      <div class="text-xs text-[var(--muted-ink)]">
        Step <span id="tutorialStep">1</span> of <span id="tutorialTotal">10</span>
      </div>
      <div class="flex gap-2">
        <button id="tutorialSkip" class="btn btn-sm">Skip</button>
        <button id="tutorialPrev" class="btn btn-sm" disabled>Previous</button>
        <button id="tutorialNext" class="btn btn-sm btn-brand">Next</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const WA_API = '/api/contents';
const GPT_API = '/api/prompts';
const DRIVE_APP_SCRIPT = 'https://script.google.com/macros/s/AKfycbwWgZ3B3vcN4flFQo1-Ul-AVjVGZozfoe8RDcbr8ez2d_d7r9XvQ7tnePY5q8ZC4w7Ziw/exec';
const waCategories = ['General','Motivation','Tech Tips','Fun Facts','Announcements','Events','Educational'];
const gptCategories = ['General','Sales','Marketing','Support','Technical','Creative','Analysis'];

/* ====== STATE ====== */
lucide.createIcons();
let currentTab = 'whatsapp';
let waContents = [];
let gptPrompts = [];
let waPage = 1, gptPage = 1;
const pageSize = 24;
let theme = localStorage.getItem('theme') || 'light';
document.documentElement.setAttribute('data-theme', theme);

/* ====== UTILS ====== */
const escapeHtml = (s='') => s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const toWhatsApp = (text='') => text
  .replace(/\*\*(.*?)\*\*/g,'*$1*').replace(/_(.*?)_/g,'_$1_')
  .replace(/~(.*?)~/g,'~$1~').replace(/`(.*?)`/g,'$1');

function whatsappPreviewHTML(text=''){
  const safe = escapeHtml(text);
  return safe
    .replace(/\*(.*?)\*/g,'<strong>$1</strong>')
    .replace(/_(.*?)_/g,'<em>$1</em>')
    .replace(/~(.*?)~/g,'<s>$1</s>')
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/\n/g,'<br/>');
}

/* ====== TAB SWITCHING ====== */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.getAttribute('data-tab');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById(`${tabName}-section`).classList.remove('hidden');
    currentTab = tabName;
    lucide.createIcons();
  });
});

/* ====== THEME ====== */
const themeBtn = document.getElementById('themeBtn');
function setTheme(next){
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  themeBtn.innerHTML = next==='dark'
    ? `<i data-lucide="sun"></i><span class="hidden md:inline">Light</span>`
    : `<i data-lucide="moon"></i><span class="hidden md:inline">Dark</span>`;
  lucide.createIcons();
}
setTheme(theme);
themeBtn.addEventListener('click',()=>{ theme=(theme==='dark'?'light':'dark'); setTheme(theme); });

/* ====== SUPPORT ====== */
document.getElementById('supportBtn').addEventListener('click', () => {
  window.open('https://forms.monday.com/forms/96d88197ad68bc429cdab62007568aad?r=use1', '_blank');
});

/* ================================================== */
/* ============== WHATSAPP CONTENT ================== */
/* ================================================== */

async function syncWAContents(){
  const res = await fetch(WA_API);
  if(!res.ok){ alert('WA Sync failed: HTTP '+res.status); return; }
  const data = await res.json();
  waContents = Array.isArray(data.items)?data.items:[];
  renderWACategories();
  renderWA();
}

async function createWAItem(payload){
  const r = await fetch(WA_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const j = await r.json().catch(()=>({})); if(!r.ok||j.error) throw new Error(j.message||j.error||('HTTP '+r.status)); return j;
}

async function updateWAItem(payload){
  const r = await fetch(WA_API,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const j = await r.json().catch(()=>({})); if(!r.ok||j.error) throw new Error(j.message||j.error||('HTTP '+r.status)); return j;
}

function renderWACategories(){
  const sel = document.getElementById('wa-categorySelect');
  const current = sel.value || 'all';
  sel.innerHTML = '<option value="all">All Categories</option>' + waCategories.map(c=>`<option value="${c}">${c}</option>`).join('');
  sel.value = current;
  const editSel = document.getElementById('wa-editCategory');
  editSel.innerHTML = waCategories.map(c=>`<option value="${c}">${c}</option>`).join('');
  const addSel = document.getElementById('wa-categoryInput');
  addSel.innerHTML = waCategories.map(c=>`<option value="${c}">${c}</option>`).join('');
}

function renderWA(){
  const grid = document.getElementById('wa-contentGrid');
  const search = (document.getElementById('wa-searchInput').value||'').toLowerCase();
  const cat = document.getElementById('wa-categorySelect').value;

  const filtered = waContents.filter(c =>
    (!search || (c.title||'').toLowerCase().includes(search) || (c.content||'').toLowerCase().includes(search) || (c.tags||[]).some(t=> (t||'').toLowerCase().includes(search))) &&
    (cat==='all' || c.category===cat)
  );

  const total = filtered.length;
  const pageCount = Math.max(1, Math.ceil(total / pageSize));
  if(waPage>pageCount) waPage = pageCount;

  const start = (waPage-1)*pageSize;
  const slice = filtered.slice(start,start+pageSize);

  grid.innerHTML = slice.map(c=>{
    const waText = c.formattedContent || toWhatsApp(c.content||'');
    const waHTML = whatsappPreviewHTML(waText);
    const bubbleId = `wa-text-${escapeHtml(c.id ?? `${start + slice.indexOf(c)}`)}`;
    return `
    <div class="h-full">
      <div class="card rounded-xl shadow-soft flex flex-col p-4 h-[420px]">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="text-lg font-semibold">${escapeHtml(c.title||'')}</h3>
            <div class="flex items-center gap-2 mt-1">
              <span class="chip bg-[var(--brand)] text-[var(--brand-ink)]">${escapeHtml(c.category||'')}</span>
              <span class="text-xs text-[var(--muted-ink)]">Used ${Number(c.useCount||0)} times</span>
            </div>
          </div>
        </div>

        <div class="mt-3 flex-1 min-h-0 rounded-lg border border-[var(--border)] bg-[var(--muted)] overflow-hidden">
          <div class="h-full overflow-auto p-3 text-sm scrollbar-thin">
            <div id="${bubbleId}" class="wa-bubble whitespace-pre-wrap w-full" data-wa-text data-wa-raw="${escapeHtml(waText).replaceAll('"','&quot;')}">
              ${waHTML}
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-1 mt-3">
          ${(c.tags||[]).map(t=>`<span class="chip bg-black/5 dark:bg-white/5">${escapeHtml('#'+t)}</span>`).join('')}
        </div>

        <div class="mt-3 flex flex-wrap items-center justify-between gap-2">
          <span class="text-xs text-[var(--muted-ink)]">Created: ${escapeHtml(c.dateCreated||'')}</span>
          <div class="flex flex-wrap items-center gap-1">
            <button class="btn btn-sm wa-editBtn" data-id="${escapeHtml(c.id||'')}">
              <i data-lucide="edit-3" class="lucide"></i><span class="hidden md:inline">Edit</span>
            </button>
            <button class="btn btn-sm wa-copyBtn" data-id="${escapeHtml(c.id||'')}">
              <i data-lucide="copy" class="lucide"></i><span class="hidden md:inline">Copy</span>
            </button>
            <button class="btn btn-sm wa-send-btn" data-wa-target="#${bubbleId}">
              <i data-lucide="send" class="lucide"></i><span class="hidden md:inline">Send</span>
            </button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');

  document.querySelectorAll('.wa-copyBtn').forEach(btn=>{
    btn.addEventListener('click',()=> copyWAToClipboard(btn.getAttribute('data-id')));
  });
  document.querySelectorAll('.wa-editBtn').forEach(btn=>{
    btn.addEventListener('click',()=> openWAEditModal(btn.getAttribute('data-id')));
  });

  lucide.createIcons();

  document.getElementById('wa-statTotal').textContent = waContents.length;
  document.getElementById('wa-statUses').textContent = waContents.reduce((a,c)=>a+(c.useCount||0),0);
  document.getElementById('wa-statCategories').textContent = new Set(waContents.map(c=>c.category)).size;
  document.getElementById('wa-statRecent').textContent = waContents.filter(c=>c.lastUsed).length;
  document.getElementById('wa-pageNum').textContent = waPage;
  document.getElementById('wa-pageCount').textContent = pageCount;
  document.getElementById('wa-prevPage').disabled = waPage<=1;
  document.getElementById('wa-nextPage').disabled = waPage>=pageCount;
}

async function copyWAToClipboard(id){
  try{
    const item = waContents.find(x=>String(x.id)===String(id));
    if(!item) return alert('Item not found.');
    await navigator.clipboard.writeText(item.formattedContent || item.content || '');
    item.useCount = Number(item.useCount||0) + 1;
    item.lastUsed = new Date().toISOString().slice(0,10);
    renderWA(); alert('Copied to clipboard!');
  }catch(e){ console.error(e); alert('Copy failed.'); }
}

/* WA EDIT */
const waEditModal = document.getElementById('wa-editModal');
const waEditTitle = document.getElementById('wa-editTitle');
const waEditCategory = document.getElementById('wa-editCategory');
const waEditContent = document.getElementById('wa-editContent');
const waEditTags = document.getElementById('wa-editTags');
const waEditPreview = document.getElementById('wa-editPreview');
let waEditItem = null;

function openWAEditModal(id){
  waEditItem = waContents.find(x=> String(x.id) === String(id));
  if(!waEditItem) return alert('Item not found');
  waEditTitle.value = waEditItem.title || '';
  waEditCategory.value = waEditItem.category || waCategories[0];
  waEditContent.value = waEditItem.content || '';
  waEditTags.value = (waEditItem.tags || []).join(', ');
  updateWAEditPreview();
  waEditModal.classList.remove('hidden'); waEditModal.classList.add('flex');
}
function closeWAEditModal(){ waEditModal.classList.add('hidden'); waEditModal.classList.remove('flex'); }
document.getElementById('wa-editClose').addEventListener('click', closeWAEditModal);
document.getElementById('wa-editCancel').addEventListener('click', closeWAEditModal);
function updateWAEditPreview(){ waEditPreview.innerHTML = whatsappPreviewHTML(toWhatsApp(waEditContent.value||'')); }
waEditContent.addEventListener('input', updateWAEditPreview);

document.getElementById('wa-editSave').addEventListener('click', async ()=>{
  if(!waEditItem) return;
  try{
    const payload = {
      id: waEditItem.id,
      title: (waEditTitle.value||'').trim(),
      category: waEditCategory.value || 'General',
      content: (waEditContent.value||'').trim(),
      formattedContent: toWhatsApp(waEditContent.value||''),
      tags: (waEditTags.value||'').split(',').map(t=>t.trim()).filter(Boolean)
    };
    await updateWAItem(payload);
    Object.assign(waEditItem,payload);
    closeWAEditModal(); renderWA(); alert('Saved.');
  }catch(e){ console.error(e); alert('Save failed: '+e.message); }
});

/* WA ADD */
const waAddModal = document.getElementById('wa-addModal');
const waTitleInput = document.getElementById('wa-titleInput');
const waCategoryInput = document.getElementById('wa-categoryInput');
const waContentInput = document.getElementById('wa-contentInput');
const waTagsInput = document.getElementById('wa-tagsInput');
const waWaPreview = document.getElementById('wa-waPreview');
const waSaveAdd = document.getElementById('wa-saveAdd');

function openWAAdd(){ resetWAAdd(); waAddModal.classList.remove('hidden'); waAddModal.classList.add('flex'); waTitleInput.focus(); }
function closeWAAdd(){ waAddModal.classList.add('hidden'); waAddModal.classList.remove('flex'); }
document.getElementById('wa-addBtn').addEventListener('click',openWAAdd);
document.getElementById('wa-addClose').addEventListener('click',closeWAAdd);
document.getElementById('wa-cancelAdd').addEventListener('click',closeWAAdd);
document.getElementById('wa-clearAdd').addEventListener('click',resetWAAdd);

function resetWAAdd(){
  waTitleInput.value=''; waCategoryInput.value=waCategories[0]; waContentInput.value=''; waTagsInput.value='';
  waWaPreview.innerHTML='(start typing above)'; updateWASaveDisabled();
}
function updateWASaveDisabled(){
  const valid=(waTitleInput.value||'').trim() && (waContentInput.value||'').trim();
  waSaveAdd.disabled = !valid;
}
waContentInput.addEventListener('input',()=>{ waWaPreview.innerHTML=whatsappPreviewHTML(toWhatsApp(waContentInput.value||'')); updateWASaveDisabled(); });
waTitleInput.addEventListener('input',updateWASaveDisabled);

waSaveAdd.addEventListener('click', async ()=>{
  try{
    waSaveAdd.disabled=true;
    const payload = {
      title:(waTitleInput.value||'').trim(),
      category: waCategoryInput.value || 'General',
      content:(waContentInput.value||'').trim(),
      formattedContent: toWhatsApp(waContentInput.value||''),
      tags:(waTagsInput.value||'').split(',').map(t=>t.trim()).filter(Boolean),
      dateCreated:new Date().toISOString().slice(0,10),
      useCount:0
    };
    await createWAItem(payload); closeWAAdd(); await syncWAContents(); alert('Content added!');
  }catch(e){ console.error(e); alert('Add failed: '+e.message); }
  finally{ waSaveAdd.disabled=false; }
});

/* WA SEND */
const waModal = document.getElementById('wa-modal');
const waPhoneInput = document.getElementById('wa-phone');
const waTextArea = document.getElementById('wa-text');

function openWASendModal(text){ waTextArea.value=text||''; waPhoneInput.value=''; waModal.classList.remove('hidden'); waModal.classList.add('flex'); setTimeout(()=>waPhoneInput.focus(),0); }
function closeWASendModal(){ waModal.classList.add('hidden'); waModal.classList.remove('flex'); }
document.getElementById('wa-cancel').addEventListener('click', closeWASendModal);
waModal.addEventListener('click', (e)=>{ if(e.target===waModal) closeWASendModal(); });

document.getElementById('wa-contentGrid').addEventListener('click', (e)=>{
  const btn = e.target.closest('.wa-send-btn'); if(!btn) return;
  const el = document.querySelector(btn.getAttribute('data-wa-target'));
  const raw = el?.getAttribute('data-wa-raw') || el?.innerText?.trim() || '';
  openWASendModal(raw);
});

document.getElementById('wa-send').addEventListener('click', async ()=>{
  const digits = waPhoneInput.value.replace(/\D/g,''); const text=waTextArea.value.trim();
  if(!digits){ alert('Enter phone number in international format (digits only).'); return; }
  if(!text){ alert('Message is empty.'); return; }
  try{
    const r = await fetch('/api/send-whatsapp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:digits,text})});
    if(!r.ok) throw new Error('HTTP '+r.status);
    alert('Sent ✅'); closeWASendModal();
  }catch(err){ console.error(err); alert('Send failed: '+String(err?.message||err)); }
});

/* WA Controls */
document.getElementById('wa-syncBtn').addEventListener('click', syncWAContents);
document.getElementById('wa-searchInput').addEventListener('input',()=>{ waPage=1; renderWA(); });
document.getElementById('wa-categorySelect').addEventListener('change',()=>{ waPage=1; renderWA(); });
document.getElementById('wa-prevPage').addEventListener('click',()=>{ if(waPage>1){ waPage--; renderWA(); }});
document.getElementById('wa-nextPage').addEventListener('click',()=>{ waPage++; renderWA(); });

/* ================================================== */
/* ================ GPT PROMPTS ===================== */
/* ================================================== */

async function syncGPTPrompts(){
  const res = await fetch(GPT_API);
  if(!res.ok){ alert('GPT Sync failed: HTTP '+res.status); return; }
  const data = await res.json();
  gptPrompts = Array.isArray(data.items)?data.items:[];
  renderGPTCategories();
  renderGPT();
}

async function createGPTItem(payload){
  const r = await fetch(GPT_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const j = await r.json().catch(()=>({})); if(!r.ok||j.error) throw new Error(j.message||j.error||('HTTP '+r.status)); return j;
}

async function updateGPTItem(payload){
  const r = await fetch(GPT_API,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const j = await r.json().catch(()=>({})); if(!r.ok||j.error) throw new Error(j.message||j.error||('HTTP '+r.status)); return j;
}

function renderGPTCategories(){
  const sel = document.getElementById('gpt-categorySelect');
  const current = sel.value || 'all';
  sel.innerHTML = '<option value="all">All Categories</option>' + gptCategories.map(c=>`<option value="${c}">${c}</option>`).join('');
  sel.value = current;
  const editSel = document.getElementById('gpt-editCategory');
  editSel.innerHTML = gptCategories.map(c=>`<option value="${c}">${c}</option>`).join('');
  const addSel = document.getElementById('gpt-categoryInput');
  addSel.innerHTML = gptCategories.map(c=>`<option value="${c}">${c}</option>`).join('');
}

function renderGPT(){
  const grid = document.getElementById('gpt-contentGrid');
  const search = (document.getElementById('gpt-searchInput').value||'').toLowerCase();
  const cat = document.getElementById('gpt-categorySelect').value;

  const filtered = gptPrompts.filter(c =>
    (!search || (c.title||'').toLowerCase().includes(search) || (c.prompt||'').toLowerCase().includes(search) || (c.tags||[]).some(t=> (t||'').toLowerCase().includes(search))) &&
    (cat==='all' || c.category===cat)
  );

  const total = filtered.length;
  const pageCount = Math.max(1, Math.ceil(total / pageSize));
  if(gptPage>pageCount) gptPage = pageCount;

  const start = (gptPage-1)*pageSize;
  const slice = filtered.slice(start,start+pageSize);

  grid.innerHTML = slice.map(c=>{
    const promptText = escapeHtml(c.prompt||'');
    return `
    <div class="h-full">
      <div class="card rounded-xl shadow-soft flex flex-col p-4 h-[420px]">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="text-lg font-semibold">${escapeHtml(c.title||'')}</h3>
            <div class="flex items-center gap-2 mt-1">
              <span class="chip bg-[var(--brand)] text-[var(--brand-ink)]">${escapeHtml(c.category||'')}</span>
              <span class="chip bg-[var(--chip)] text-[var(--chip-ink)]">${escapeHtml(c.model||'GPT-4')}</span>
              <span class="text-xs text-[var(--muted-ink)]">Used ${Number(c.useCount||0)} times</span>
            </div>
          </div>
        </div>

        ${c.systemRole?`<div class="mt-2 text-xs text-[var(--muted-ink)] italic">System: ${escapeHtml(c.systemRole.slice(0,100))}${c.systemRole.length>100?'...':''}</div>`:''}

        <div class="mt-3 flex-1 min-h-0 rounded-lg border border-[var(--border)] bg-[var(--muted)] overflow-hidden">
          <div class="h-full overflow-auto p-3 text-sm scrollbar-thin">
            <div class="prompt-bubble whitespace-pre-wrap w-full" data-prompt-id="${escapeHtml(c.id||'')}">${promptText}</div>
          </div>
        </div>

        <div class="flex flex-wrap gap-1 mt-3">
          ${(c.tags||[]).map(t=>`<span class="chip bg-black/5 dark:bg-white/5">${escapeHtml('#'+t)}</span>`).join('')}
        </div>

        <div class="mt-3 flex flex-wrap items-center justify-between gap-2">
          <span class="text-xs text-[var(--muted-ink)]">Created: ${escapeHtml(c.dateCreated||'')}</span>
          <div class="flex flex-wrap items-center gap-1">
            <button class="btn btn-sm gpt-editBtn" data-id="${escapeHtml(c.id||'')}">
              <i data-lucide="edit-3" class="lucide"></i><span class="hidden md:inline">Edit</span>
            </button>
            <button class="btn btn-sm gpt-copyBtn" data-id="${escapeHtml(c.id||'')}">
              <i data-lucide="copy" class="lucide"></i><span class="hidden md:inline">Copy</span>
            </button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');

  document.querySelectorAll('.gpt-copyBtn').forEach(btn=>{
    btn.addEventListener('click',()=> copyGPTToClipboard(btn.getAttribute('data-id')));
  });
  document.querySelectorAll('.gpt-editBtn').forEach(btn=>{
    btn.addEventListener('click',()=> openGPTEditModal(btn.getAttribute('data-id')));
  });

  lucide.createIcons();

  document.getElementById('gpt-statTotal').textContent = gptPrompts.length;
  document.getElementById('gpt-statUses').textContent = gptPrompts.reduce((a,c)=>a+(c.useCount||0),0);
  document.getElementById('gpt-statCategories').textContent = new Set(gptPrompts.map(c=>c.category)).size;
  document.getElementById('gpt-statRecent').textContent = gptPrompts.filter(c=>c.lastUsed).length;
  document.getElementById('gpt-pageNum').textContent = gptPage;
  document.getElementById('gpt-pageCount').textContent = pageCount;
  document.getElementById('gpt-prevPage').disabled = gptPage<=1;
  document.getElementById('gpt-nextPage').disabled = gptPage>=pageCount;
}

async function copyGPTToClipboard(id){
  try{
    const item = gptPrompts.find(x=>String(x.id)===String(id));
    if(!item) return alert('Item not found.');
    const fullText = (item.systemRole ? `System: ${item.systemRole}\n\n` : '') + (item.prompt || '');
    await navigator.clipboard.writeText(fullText);
    item.useCount = Number(item.useCount||0) + 1;
    item.lastUsed = new Date().toISOString().slice(0,10);
    renderGPT(); alert('Copied to clipboard!');
  }catch(e){ console.error(e); alert('Copy failed.'); }
}

/* GPT EDIT */
const gptEditModal = document.getElementById('gpt-editModal');
const gptEditTitle = document.getElementById('gpt-editTitle');
const gptEditCategory = document.getElementById('gpt-editCategory');
const gptEditModel = document.getElementById('gpt-editModel');
const gptEditSystemRole = document.getElementById('gpt-editSystemRole');
const gptEditPrompt = document.getElementById('gpt-editPrompt');
const gptEditTags = document.getElementById('gpt-editTags');
let gptEditItem = null;

function openGPTEditModal(id){
  gptEditItem = gptPrompts.find(x=> String(x.id) === String(id));
  if(!gptEditItem) return alert('Item not found');
  gptEditTitle.value = gptEditItem.title || '';
  gptEditCategory.value = gptEditItem.category || gptCategories[0];
  gptEditModel.value = gptEditItem.model || 'GPT-4';
  gptEditSystemRole.value = gptEditItem.systemRole || '';
  gptEditPrompt.value = gptEditItem.prompt || '';
  gptEditTags.value = (gptEditItem.tags || []).join(', ');
  gptEditModal.classList.remove('hidden'); gptEditModal.classList.add('flex');
}
function closeGPTEditModal(){ gptEditModal.classList.add('hidden'); gptEditModal.classList.remove('flex'); }
document.getElementById('gpt-editClose').addEventListener('click', closeGPTEditModal);
document.getElementById('gpt-editCancel').addEventListener('click', closeGPTEditModal);

document.getElementById('gpt-editSave').addEventListener('click', async ()=>{
  if(!gptEditItem) return;
  try{
    const payload = {
      id: gptEditItem.id,
      title: (gptEditTitle.value||'').trim(),
      category: gptEditCategory.value || 'General',
      model: gptEditModel.value || 'GPT-4',
      systemRole: (gptEditSystemRole.value||'').trim(),
      prompt: (gptEditPrompt.value||'').trim(),
      tags: (gptEditTags.value||'').split(',').map(t=>t.trim()).filter(Boolean)
    };
    await updateGPTItem(payload);
    Object.assign(gptEditItem,payload);
    closeGPTEditModal(); renderGPT(); alert('Saved.');
  }catch(e){ console.error(e); alert('Save failed: '+e.message); }
});

/* GPT ADD */
const gptAddModal = document.getElementById('gpt-addModal');
const gptTitleInput = document.getElementById('gpt-titleInput');
const gptCategoryInput = document.getElementById('gpt-categoryInput');
const gptModelInput = document.getElementById('gpt-modelInput');
const gptSystemRoleInput = document.getElementById('gpt-systemRoleInput');
const gptPromptInput = document.getElementById('gpt-promptInput');
const gptTagsInput = document.getElementById('gpt-tagsInput');
const gptSaveAdd = document.getElementById('gpt-saveAdd');

function openGPTAdd(){ resetGPTAdd(); gptAddModal.classList.remove('hidden'); gptAddModal.classList.add('flex'); gptTitleInput.focus(); }
function closeGPTAdd(){ gptAddModal.classList.add('hidden'); gptAddModal.classList.remove('flex'); }
document.getElementById('gpt-addBtn').addEventListener('click',openGPTAdd);
document.getElementById('gpt-addClose').addEventListener('click',closeGPTAdd);
document.getElementById('gpt-cancelAdd').addEventListener('click',closeGPTAdd);
document.getElementById('gpt-clearAdd').addEventListener('click',resetGPTAdd);

function resetGPTAdd(){
  gptTitleInput.value=''; gptCategoryInput.value=gptCategories[0]; gptModelInput.value='GPT-4';
  gptSystemRoleInput.value=''; gptPromptInput.value=''; gptTagsInput.value='';
  updateGPTSaveDisabled();
}
function updateGPTSaveDisabled(){
  const valid=(gptTitleInput.value||'').trim() && (gptPromptInput.value||'').trim();
  gptSaveAdd.disabled = !valid;
}
gptPromptInput.addEventListener('input',updateGPTSaveDisabled);
gptTitleInput.addEventListener('input',updateGPTSaveDisabled);

gptSaveAdd.addEventListener('click', async ()=>{
  try{
    gptSaveAdd.disabled=true;
    const payload = {
      title:(gptTitleInput.value||'').trim(),
      category: gptCategoryInput.value || 'General',
      model: gptModelInput.value || 'GPT-4',
      systemRole: (gptSystemRoleInput.value||'').trim(),
      prompt:(gptPromptInput.value||'').trim(),
      tags:(gptTagsInput.value||'').split(',').map(t=>t.trim()).filter(Boolean),
      dateCreated:new Date().toISOString().slice(0,10),
      useCount:0
    };
    await createGPTItem(payload); closeGPTAdd(); await syncGPTPrompts(); alert('Prompt added!');
  }catch(e){ console.error(e); alert('Add failed: '+e.message); }
  finally{ gptSaveAdd.disabled=false; }
});

/* GPT Controls */
document.getElementById('gpt-syncBtn').addEventListener('click', syncGPTPrompts);
document.getElementById('gpt-searchInput').addEventListener('input',()=>{ gptPage=1; renderGPT(); });
document.getElementById('gpt-categorySelect').addEventListener('change',()=>{ gptPage=1; renderGPT(); });
document.getElementById('gpt-prevPage').addEventListener('click',()=>{ if(gptPage>1){ gptPage--; renderGPT(); }});
document.getElementById('gpt-nextPage').addEventListener('click',()=>{ gptPage++; renderGPT(); });

/* ================================================== */
/* ================== TUTORIAL ====================== */
/* ================================================== */

const tutorialSteps = [
  {
    title: 'Welcome to Content Library!',
    text: 'This tutorial will guide you through all the features. You can skip it anytime and restart later by clicking the Tutorial button.',
    target: null,
    position: 'center'
  },
  {
    title: 'Need Help?',
    text: 'Click the Support button anytime to submit feedback, report issues, or request features via our support form.',
    target: '#supportBtn',
    position: 'bottom'
  },
  {
    title: 'Navigation Tabs',
    text: 'Switch between WhatsApp Content and GPT Prompts libraries using these tabs.',
    target: '[data-tab="whatsapp"]',
    position: 'bottom'
  },
  {
    title: 'Search Content',
    text: 'Search for content by title, keywords, or tags. Filter by category using the dropdown.',
    target: '#wa-searchInput',
    position: 'bottom',
    beforeShow: () => { document.querySelector('[data-tab="whatsapp"]').click(); }
  },
  {
    title: 'Add New Content',
    text: 'Click here to add new WhatsApp content with formatting, tags, and attachments.',
    target: '#wa-addBtn',
    position: 'left'
  },
  {
    title: 'Sync Data',
    text: 'Click Sync to refresh content from your Notion database.',
    target: '#wa-syncBtn',
    position: 'left'
  },
  {
    title: 'Content Cards',
    text: 'Each card shows your content with WhatsApp preview. You can Edit, Copy, or Send via WhatsApp.',
    target: '#wa-contentGrid',
    position: 'top',
    waitForElement: true
  },
  {
    title: 'Usage Statistics',
    text: 'Track how many times content is used, total items, and other statistics here.',
    target: '.card.rounded-xl.p-4.shadow-soft',
    position: 'top'
  },
  {
    title: 'GPT Prompts Library',
    text: 'Now let\'s explore the GPT Prompts section. Click Next to continue.',
    target: '[data-tab="prompts"]',
    position: 'bottom',
    beforeShow: () => { document.querySelector('[data-tab="prompts"]').click(); }
  },
  {
    title: 'Add New Prompt',
    text: 'Create standardized prompts with system roles, model recommendations, and tags.',
    target: '#gpt-addBtn',
    position: 'left'
  },
  {
    title: 'Copy & Use Prompts',
    text: 'Click Copy on any prompt to copy it to clipboard, then paste it into ChatGPT, Claude, or any AI tool.',
    target: '#gpt-contentGrid',
    position: 'top',
    waitForElement: true
  },
  {
    title: 'Tutorial Complete!',
    text: 'You\'re all set! Click the Tutorial button anytime to see this guide again. Happy organizing!',
    target: null,
    position: 'center'
  }
];

let currentTutorialStep = 0;

const tutorialOverlay = document.getElementById('tutorialOverlay');
const tutorialHighlight = document.getElementById('tutorialHighlight');
const tutorialTooltip = document.getElementById('tutorialTooltip');
const tutorialArrow = document.getElementById('tutorialArrow');
const tutorialTitle = document.getElementById('tutorialTitle');
const tutorialText = document.getElementById('tutorialText');
const tutorialStepSpan = document.getElementById('tutorialStep');
const tutorialTotalSpan = document.getElementById('tutorialTotal');
const tutorialPrevBtn = document.getElementById('tutorialPrev');
const tutorialNextBtn = document.getElementById('tutorialNext');
const tutorialSkipBtn = document.getElementById('tutorialSkip');

function startTutorial(){
  currentTutorialStep = 0;
  tutorialOverlay.classList.add('active');
  tutorialTotalSpan.textContent = tutorialSteps.length;
  showTutorialStep(0);
}

function endTutorial(){
  tutorialOverlay.classList.remove('active');
  currentTutorialStep = 0;
}

function showTutorialStep(stepIndex){
  if(stepIndex < 0 || stepIndex >= tutorialSteps.length){
    endTutorial();
    return;
  }

  currentTutorialStep = stepIndex;
  const step = tutorialSteps[stepIndex];

  // Run beforeShow callback if exists
  if(step.beforeShow) step.beforeShow();

  // Update content
  tutorialTitle.textContent = step.title;
  tutorialText.textContent = step.text;
  tutorialStepSpan.textContent = stepIndex + 1;

  // Update buttons
  tutorialPrevBtn.disabled = stepIndex === 0;
  tutorialNextBtn.textContent = stepIndex === tutorialSteps.length - 1 ? 'Finish' : 'Next';

  // Position tooltip and highlight
  if(step.target){
    const targetEl = document.querySelector(step.target);
    if(!targetEl){
      if(step.waitForElement){
        // Wait a bit for content to load
        setTimeout(() => showTutorialStep(stepIndex), 500);
        return;
      }
      // Skip to next step if target not found
      showTutorialStep(stepIndex + 1);
      return;
    }

    const rect = targetEl.getBoundingClientRect();

    // Position highlight
    tutorialHighlight.style.display = 'block';
    tutorialHighlight.style.left = (rect.left - 10) + 'px';
    tutorialHighlight.style.top = (rect.top - 10) + 'px';
    tutorialHighlight.style.width = (rect.width + 20) + 'px';
    tutorialHighlight.style.height = (rect.height + 20) + 'px';

    // Position tooltip
    positionTooltip(rect, step.position);
  } else {
    // Center tooltip for steps without target
    tutorialHighlight.style.display = 'none';
    tutorialTooltip.style.left = '50%';
    tutorialTooltip.style.top = '50%';
    tutorialTooltip.style.transform = 'translate(-50%, -50%)';
    tutorialArrow.className = 'tutorial-arrow';
    tutorialArrow.style.display = 'none';
  }

  lucide.createIcons();
}

function positionTooltip(rect, position){
  tutorialArrow.style.display = 'block';
  tutorialArrow.className = 'tutorial-arrow';
  tutorialTooltip.style.transform = 'none';

  const tooltipRect = tutorialTooltip.getBoundingClientRect();
  const padding = 20;

  switch(position){
    case 'top':
      tutorialTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
      tutorialTooltip.style.top = (rect.top - tooltipRect.height - padding) + 'px';
      tutorialArrow.classList.add('bottom');
      break;
    case 'bottom':
      tutorialTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
      tutorialTooltip.style.top = (rect.bottom + padding) + 'px';
      tutorialArrow.classList.add('top');
      break;
    case 'left':
      tutorialTooltip.style.left = (rect.left - tooltipRect.width - padding) + 'px';
      tutorialTooltip.style.top = (rect.top + rect.height / 2 - tooltipRect.height / 2) + 'px';
      tutorialArrow.classList.add('right');
      break;
    case 'right':
      tutorialTooltip.style.left = (rect.right + padding) + 'px';
      tutorialTooltip.style.top = (rect.top + rect.height / 2 - tooltipRect.height / 2) + 'px';
      tutorialArrow.classList.add('left');
      break;
    default:
      tutorialTooltip.style.left = '50%';
      tutorialTooltip.style.top = '50%';
      tutorialTooltip.style.transform = 'translate(-50%, -50%)';
      tutorialArrow.style.display = 'none';
  }

  // Keep tooltip in viewport
  const tooltipFinalRect = tutorialTooltip.getBoundingClientRect();
  if(tooltipFinalRect.right > window.innerWidth - 20){
    tutorialTooltip.style.left = (window.innerWidth - tooltipFinalRect.width - 20) + 'px';
  }
  if(tooltipFinalRect.left < 20){
    tutorialTooltip.style.left = '20px';
  }
  if(tooltipFinalRect.top < 20){
    tutorialTooltip.style.top = '20px';
  }
}

// Tutorial button events
document.getElementById('tutorialBtn').addEventListener('click', startTutorial);
tutorialPrevBtn.addEventListener('click', () => showTutorialStep(currentTutorialStep - 1));
tutorialNextBtn.addEventListener('click', () => {
  if(currentTutorialStep === tutorialSteps.length - 1){
    endTutorial();
  } else {
    showTutorialStep(currentTutorialStep + 1);
  }
});
tutorialSkipBtn.addEventListener('click', endTutorial);

// Close tutorial on overlay click (outside tooltip)
tutorialOverlay.addEventListener('click', (e) => {
  if(e.target === tutorialOverlay) endTutorial();
});

// Handle window resize
window.addEventListener('resize', () => {
  if(tutorialOverlay.classList.contains('active')){
    showTutorialStep(currentTutorialStep);
  }
});

/* ====== BOOT ====== */
window.addEventListener('DOMContentLoaded',()=>{
  renderWACategories();
  renderGPTCategories();
  syncWAContents();
  syncGPTPrompts();
});
</script>
</body>
</html>
