<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Content Library</title>
  <link rel="icon" href="data:,"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root{
      --ink:#0b0b0c; --fg:#0b0b0c; --muted:#f4f5f7; --muted-ink:#6b7280;
      --brand:#d6b160; --brand-ink:#000; --chip:#0f766e; --chip-ink:#ecfeff;
      --card:#ffffff; --border:rgba(0,0,0,.07);
    }
    body{ background:#fff; color:var(--fg); }
    .card{ background:var(--card); border:1px solid var(--border); }
    .chip{ border-radius:9999px; padding:2px 8px; font-size:12px }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--border); padding:.5rem .75rem; border-radius:.75rem; }
    .btn:hover:not([disabled]){ background:rgba(0,0,0,.03) }
    .btn-brand{ background:var(--brand); color:var(--brand-ink); border-color:transparent; }
    .btn-brand:hover:not([disabled]){ filter:brightness(.95) }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .shadow-soft{ box-shadow:0 8px 30px rgba(0,0,0,.06) }
    .scrollbar-thin{ scrollbar-width: thin; }
    .scrollbar-thin::-webkit-scrollbar{ height:6px; width:6px;}
    .scrollbar-thin::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.2); border-radius:999px;}

    .wa-bubble { background:#e7f1e9; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; }
    .wa-bubble strong{ font-weight:700; }
    .wa-bubble em{ font-style:italic; }
    .wa-bubble s{ text-decoration:line-through; }
    .wa-bubble code{
      background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:6px; padding:1px 4px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.875em;
    }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <h1 class="text-3xl font-bold flex items-center gap-2 tracking-tight">
        <i data-lucide="message-circle"></i> WhatsApp Content Library
      </h1>
      <div class="flex gap-2">
        <button id="syncBtn" class="btn"><i data-lucide="refresh-cw"></i> Sync Now</button>
        <button id="addBtn" class="btn btn-brand"><i data-lucide="plus"></i> Add Content</button>
      </div>
    </header>

    <!-- Toolbar -->
    <section class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex gap-2 w-full md:w-auto">
        <input id="searchInput" placeholder="Search..." class="flex-1 p-3 rounded-lg border border-[var(--border)] bg-white"/>
        <select id="categorySelect" class="p-3 rounded-lg border border-[var(--border)] bg-white">
          <option value="all">All Categories</option>
        </select>
      </div>
      <div class="flex gap-2 items-center">
        <label class="text-sm">Density</label>
        <select id="densitySelect" class="p-2 rounded-lg border border-[var(--border)] bg-white">
          <option value="comfortable">Comfortable</option>
          <option value="compact">Compact</option>
        </select>
        <label class="text-sm">Items per page</label>
        <select id="pageSizeSelect" class="p-2 rounded-lg border border-[var(--border)] bg-white">
          <option>6</option><option>9</option><option selected>12</option><option>18</option><option>24</option>
        </select>
      </div>
    </section>

    <!-- Grid -->
    <section>
      <div id="contentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch"></div>
      <div class="flex items-center justify-between mt-4">
        <button id="prevPage" class="btn" disabled><i data-lucide="chevron-left"></i> Prev</button>
        <div class="text-sm text-[var(--muted-ink)]">Page <span id="pageNum">1</span> of <span id="pageCount">1</span></div>
        <button id="nextPage" class="btn">Next <i data-lucide="chevron-right"></i></button>
      </div>
    </section>

    <!-- Stats -->
    <section class="card rounded-xl p-4 shadow-soft">
      <h2 class="font-semibold mb-2">Content Statistics</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div><div id="statTotal" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Total Content</div></div>
        <div><div id="statUses" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Total Uses</div></div>
        <div><div id="statCategories" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Categories</div></div>
        <div><div id="statRecent" class="text-2xl font-bold">0</div><div class="text-sm text-[var(--muted-ink)]">Recently Used</div></div>
      </div>
    </section>
  </div>

  <!-- Edit Content Modal -->
  <div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
    <div class="card w-full max-w-2xl rounded-xl shadow-soft flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
        <h2 class="text-xl font-semibold">Edit Content</h2>
        <button id="editClose" class="btn"><i data-lucide="x"></i></button>
      </div>
      <div class="p-4 space-y-4 overflow-y-auto scrollbar-thin" style="max-height:60vh">
        <div>
          <label class="block text-sm mb-1">Title</label>
          <input id="editTitle" class="w-full p-2 rounded-lg border border-[var(--border)] bg-white"/>
        </div>
        <div>
          <label class="block text-sm mb-1">Category</label>
          <select id="editCategory" class="w-full p-2 rounded-lg border border-[var(--border)] bg-white"></select>
        </div>
        <div>
          <label class="block text-sm mb-1">Content</label>
          <textarea id="editContent" rows="8" class="w-full p-2 rounded-lg border border-[var(--border)] bg-white"></textarea>
        </div>
        <div>
          <label class="block text-sm mb-1">Tags (comma separated)</label>
          <input id="editTags" class="w-full p-2 rounded-lg border border-[var(--border)] bg-white"/>
        </div>

        <!-- Attachments list with rename -->
        <div>
          <label class="block text-sm mb-2">Attachments</label>
          <div id="editAttachments" class="flex flex-col gap-2"></div>
          <p class="text-xs text-[var(--muted-ink)] mt-1">Renaming changes the file name in Drive and this record.</p>
        </div>

        <!-- Preview -->
        <div>
          <label class="block text-sm mb-1">WhatsApp Preview</label>
          <div class="rounded-lg border border-[var(--border)] bg-[var(--muted)] p-2">
            <div id="editPreview" class="wa-bubble text-sm max-h-48 overflow-auto whitespace-pre-wrap scrollbar-thin"></div>
          </div>
        </div>
      </div>
      <div class="p-4 border-t border-[var(--border)] flex justify-end gap-2">
        <button id="editCancel" class="btn">Cancel</button>
        <button id="editSave" class="btn btn-brand">
          <span id="editSaveText">Save changes</span>
          <svg id="editSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Add Content Modal (unchanged from your working one) -->
  <!-- If you already have the Add modal working, keep yours.
       Omitted here for brevity to focus on Edit/Rename/Pagination. -->

<script>
  // ====== CONFIG ======
  const API = 'https://whatsapp-content-library.vercel.app/api/contents';
  const DRIVE_APP_SCRIPT = 'https://script.google.com/macros/s/AKfycbwWgZ3B3vcN4flFQo1-Ul-AVjVGZozfoe8RDcbr8ez2d_d7r9XvQ7tnePY5q8ZC4w7Ziw/exec';
  const categories = ['Motivation','Tech Tips','Fun Facts','Announcements','Events','Educational'];

  // ====== STATE ======
  lucide.createIcons();
  let contents = [];
  // view state
  let density = localStorage.getItem('density') || 'comfortable';
  let pageSize = Number(localStorage.getItem('pageSize') || '12');
  let page = 1;

  // ====== UTILS ======
  const escapeHtml = (s='') => s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  const toWhatsApp = (text='') => text
    .replace(/\*\*(.*?)\*\*/g,'*$1*').replace(/__(.*?)__/g,'_$1_')
    .replace(/~~(.*?)~~/g,'~$1~').replace(/`(.*?)`/g,'$1');
  function whatsappPreviewHTML(text=''){
    const safe = escapeHtml(text);
    return safe
      .replace(/\*(.*?)\*/g,'<strong>$1</strong>')
      .replace(/_(.*?)_/g,'<em>$1</em>')
      .replace(/~(.*?)~/g,'<s>$1</s>')
      .replace(/`([^`]+)`/g,'<code>$1</code>')
      .replace(/\n/g,'<br/>');
  }

  // ====== API ======
  async function syncContents(){
    const res = await fetch(API);
    if(!res.ok) { alert('Sync failed: HTTP '+res.status); return; }
    const data = await res.json();
    contents = Array.isArray(data.items)?data.items:[];
    renderCategories();
    render();
  }

  async function updateItem(payload){
    const res = await fetch(API, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await res.json().catch(()=> ({}));
    if(!res.ok || j.error){ throw new Error(j.message || j.error || ('HTTP '+res.status)); }
    return j;
  }

  async function renameDriveFile(fileId, newName){
    const res = await fetch(DRIVE_APP_SCRIPT, {
      method:'POST',
      body: JSON.stringify({ action:'rename', fileId, newName })
    });
    const j = await res.json();
    if(!res.ok || !j.success){ throw new Error(j.error || 'Rename failed'); }
    return j.file; // {id, name, url, webViewLink}
  }

  // ====== RENDER + VIEWS ======
  function render(){
    const grid = document.getElementById('contentGrid');
    const search = (document.getElementById('searchInput').value||'').toLowerCase();
    const cat = document.getElementById('categorySelect').value;

    const filtered = contents.filter(c =>
      (!search || (c.title||'').toLowerCase().includes(search) || (c.content||'').toLowerCase().includes(search) || (c.tags||[]).some(t=> (t||'').toLowerCase().includes(search))) &&
      (cat==='all' || c.category===cat)
    );

    const total = filtered.length;
    const pageCount = Math.max(1, Math.ceil(total / pageSize));
    if(page > pageCount) page = pageCount;

    const start = (page-1)*pageSize;
    const slice = filtered.slice(start, start+pageSize);

    grid.innerHTML = slice.map(c => {
      const waText = c.formattedContent || toWhatsApp(c.content || '');
      const waHTML = whatsappPreviewHTML(waText);
      const comfy = density === 'comfortable';

      return `
      <div class="h-full">
        <div class="card rounded-xl shadow-soft flex flex-col ${comfy ? 'p-4 h-[420px]' : 'p-3 h-[360px]'}">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="${comfy?'text-lg':'text-base'} font-semibold">${escapeHtml(c.title||'')}</h3>
              <div class="flex items-center gap-2 mt-1">
                <span class="chip bg-[var(--brand)] text-[var(--brand-ink)]">${escapeHtml(c.category||'')}</span>
                <span class="text-xs text-[var(--muted-ink)]">Used ${Number(c.useCount||0)} times</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="btn editBtn" data-id="${escapeHtml(c.id||'')}"><i data-lucide="pencil"></i> Edit</button>
              <button class="btn copyBtn" data-id="${escapeHtml(c.id||'')}"><i data-lucide="copy"></i> Copy</button>
            </div>
          </div>

          ${(c.attachments&&c.attachments.length) ? `
          <div class="flex flex-wrap gap-2 mt-2">
            ${c.attachments.map(a => `
              <a href="${escapeHtml(a.url)}" target="_blank" class="chip ${comfy?'':'text-xs'} bg-[var(--chip)] text-[var(--chip-ink)] hover:opacity-90">${escapeHtml(a.name)}</a>
            `).join('')}
          </div>` : ''}

          <div class="mt-3 flex-1 min-h-0 rounded-lg border border-[var(--border)] bg-[var(--muted)] overflow-hidden">
            <div class="h-full overflow-auto ${comfy?'p-3 text-sm':'p-2 text-[13px]'} scrollbar-thin">
              <div class="wa-bubble whitespace-pre-wrap w-full">${waHTML}</div>
            </div>
          </div>

          <div class="flex flex-wrap gap-1 mt-3 ${comfy?'':'text-xs'}">
            ${(c.tags||[]).map(t=>`<span class="chip bg-black/5">${escapeHtml('#'+t)}</span>`).join('')}
          </div>

          <div class="text-xs text-[var(--muted-ink)] flex justify-between mt-auto pt-3">
            <span>Created: ${escapeHtml(c.dateCreated||'')}</span>
            ${c.lastUsed ? `<span>Last used: ${escapeHtml(c.lastUsed)}</span>` : '<span></span>'}
          </div>
        </div>
      </div>`;
    }).join('');

    // Buttons & pagination labels
    document.querySelectorAll('.copyBtn').forEach(btn=>{
      btn.addEventListener('click', ()=> copyToClipboard(btn.getAttribute('data-id')));
    });
    document.querySelectorAll('.editBtn').forEach(btn=>{
      btn.addEventListener('click', ()=> openEditModal(btn.getAttribute('data-id')));
    });

    document.getElementById('statTotal').textContent = contents.length;
    document.getElementById('statUses').textContent = contents.reduce((a,c)=>a+(c.useCount||0),0);
    document.getElementById('statCategories').textContent = new Set(contents.map(c=>c.category)).size;
    document.getElementById('statRecent').textContent = contents.filter(c=>c.lastUsed).length;

    document.getElementById('pageNum').textContent = page;
    document.getElementById('pageCount').textContent = pageCount;
    prevPage.disabled = page<=1;
    nextPage.disabled = page>=pageCount;

    lucide.createIcons();
  }

  function renderCategories(){
    const sel = document.getElementById('categorySelect');
    const current = sel.value || 'all';
    sel.innerHTML = '<option value="all">All Categories</option>' + categories.map(c=>`<option value="${c}">${c}</option>`).join('');
    sel.value = current;

    const editSel = document.getElementById('editCategory');
    editSel.innerHTML = categories.map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  async function copyToClipboard(id){
    try{
      const item = contents.find(x=>String(x.id)===String(id));
      if(!item) return alert('Item not found.');
      await navigator.clipboard.writeText(item.formattedContent || item.content || '');
      item.useCount = Number(item.useCount||0) + 1;
      item.lastUsed = new Date().toISOString().slice(0,10);
      render();
      alert('Copied to clipboard!');
    }catch(e){ console.error(e); alert('Copy failed.'); }
  }

  // ====== EDIT MODAL ======
  const editModal = document.getElementById('editModal');
  const editClose = document.getElementById('editClose');
  const editCancel = document.getElementById('editCancel');
  const editSave = document.getElementById('editSave');
  const editSaveText = document.getElementById('editSaveText');
  const editSpinner = document.getElementById('editSpinner');

  const editTitle = document.getElementById('editTitle');
  const editCategory = document.getElementById('editCategory');
  const editContent = document.getElementById('editContent');
  const editTags = document.getElementById('editTags');
  const editAttachments = document.getElementById('editAttachments');
  const editPreview = document.getElementById('editPreview');

  let editItem = null;

  function openEditModal(id){
    editItem = contents.find(x=> String(x.id) === String(id));
    if(!editItem) return alert('Item not found');

    editTitle.value = editItem.title || '';
    editCategory.value = editItem.category || categories[0];
    editContent.value = editItem.content || '';
    editTags.value = (editItem.tags || []).join(', ');

    drawEditAttachments();
    updateEditPreview();

    editModal.classList.remove('hidden');
    editModal.classList.add('flex');
  }
  function closeEditModal(){
    editModal.classList.add('hidden');
    editModal.classList.remove('flex');
  }
  editClose.addEventListener('click', closeEditModal);
  editCancel.addEventListener('click', closeEditModal);

  function updateEditPreview(){
    const waText = toWhatsApp(editContent.value || '');
    editPreview.innerHTML = whatsappPreviewHTML(waText);
  }
  editContent.addEventListener('input', updateEditPreview);

  function drawEditAttachments(){
    const list = (editItem.attachments || []);
    if (!list.length){ editAttachments.innerHTML = '<div class="text-sm text-[var(--muted-ink)]">No files.</div>'; return; }

    editAttachments.innerHTML = list.map((a,idx)=>`
      <div class="flex items-center gap-2 border border-[var(--border)] rounded-lg p-2">
        <i data-lucide="file" class="w-4 h-4"></i>
        <a class="underline text-sm" href="${escapeHtml(a.url)}" target="_blank">${escapeHtml(a.name)}</a>
        ${a.id ? `
        <input class="p-1 border border-[var(--border)] rounded text-sm" value="${escapeHtml(a.name)}" id="attName${idx}" />
        <button class="btn text-xs renameBtn" data-idx="${idx}"><i data-lucide="edit-3"></i> Rename</button>
        ` : `<span class="text-xs text-[var(--muted-ink)]">(cannot rename — no fileId)</span>`}
      </div>
    `).join('');
    editAttachments.querySelectorAll('.renameBtn').forEach(b=>{
      b.addEventListener('click', async ()=>{
      const i = Number(b.getAttribute('data-idx'));
      const att = editItem.attachments[i];
      const input = document.getElementById('attName'+i);
      const newName = (input.value||'').trim();
      if(!newName) return alert('Enter a new name');
      try{
        b.disabled = true;
        const renamed = await renameDriveFile(att.id, newName);
        // Update in-memory
        editItem.attachments[i].name = renamed.name;
        // keep same url (Drive url doesn't need to change)
        drawEditAttachments();
        alert('Renamed.');
      }catch(err){
        console.error(err); alert('Rename failed: '+err.message);
      }finally{
        b.disabled = false;
      }
      });
    });
    lucide.createIcons();
  }

  editSave.addEventListener('click', async ()=>{
    if(!editItem) return;
    try{
      editSave.disabled = true;
      editSaveText.textContent = 'Saving…';
      editSpinner.classList.remove('hidden');

      const payload = {
        id: editItem.id,
        title: (editTitle.value||'').trim(),
        category: editCategory.value || 'General',
        content: (editContent.value||'').trim(),
        formattedContent: toWhatsApp(editContent.value||''),
        tags: (editTags.value||'').split(',').map(t=>t.trim()).filter(Boolean),
        attachments: (editItem.attachments||[]).map(a=>({ id:a.id, name:a.name, url:a.url }))
      };

      await updateItem(payload);
      // update local copy for instant UI refresh
      Object.assign(editItem, payload);
      closeEditModal();
      render();
      alert('Saved.');
    }catch(e){
      console.error(e); alert('Save failed: '+e.message);
    }finally{
      editSave.disabled = false;
      editSaveText.textContent = 'Save changes';
      editSpinner.classList.add('hidden');
    }
  });

  // ====== CONTROLS / VIEW ======
  document.getElementById('searchInput').addEventListener('input', ()=>{ page=1; render(); });
  document.getElementById('categorySelect').addEventListener('change', ()=>{ page=1; render(); });

  const densitySelect = document.getElementById('densitySelect');
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  const prevPage = document.getElementById('prevPage');
  const nextPage = document.getElementById('nextPage');

  densitySelect.value = density;
  pageSizeSelect.value = String(pageSize);

  densitySelect.addEventListener('change', ()=>{
    density = densitySelect.value;
    localStorage.setItem('density', density);
    render();
  });
  pageSizeSelect.addEventListener('change', ()=>{
    pageSize = Number(pageSizeSelect.value);
    localStorage.setItem('pageSize', String(pageSize));
    page = 1;
    render();
  });
  prevPage.addEventListener('click', ()=>{ if(page>1){ page--; render(); }});
  nextPage.addEventListener('click', ()=>{ page++; render(); });

  // ====== BOOT ======
  window.addEventListener('DOMContentLoaded', ()=>{
    renderCategories();
    syncContents();
  });
</script>
</body>
</html>
